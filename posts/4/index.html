
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JustQyx</title>
  <meta name="author" content="é‚±æºé‘«">

  
  <meta name="description" content="Create and configure lightweight, reproducible, and portable development environments.
åˆ›å»ºå’Œé…ç½®è½»é‡çº§çš„ã€å¯å¤åˆ¶çš„å’Œä¾¿äºæºå¸¦çš„å¼€å‘ç¯å¢ƒã€‚ Vagrant æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿåœ°æ„å»ºã€ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.justqyx.me/posts/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="JustQyx" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-65882934-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">JustQyx</a></h1>
  
    <h2>å¤§é“è‡³ç®€</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="hzuqiuyuanxin@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="www.justqyx.me">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/blog/blogs">Blogs</a></li>
  <li><a href="/blog/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/19/vagrant/">Vagrant</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-19T14:42:37+08:00'><span class='date'>2014-12-19 14:42:37</span> <span class='time'>2:42 pm</span></time>
        
           | <a href="/blog/2014/12/19/vagrant/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/12/19/vagrant/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>Create and configure lightweight, reproducible, and portable development environments.<br/>
åˆ›å»ºå’Œé…ç½®è½»é‡çº§çš„ã€å¯å¤åˆ¶çš„å’Œä¾¿äºæºå¸¦çš„å¼€å‘ç¯å¢ƒã€‚</p></blockquote>

<p><a href="https://www.vagrantup.com/">Vagrant</a> æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿåœ°æ„å»ºã€é‡å»ºä¸€ä¸ªå¹²å‡€çš„æˆ–é…ç½®å¥½çš„è™šæ‹Ÿæœºç¯å¢ƒï¼Œä»¥ä¾›å¼€å‘å’Œæµ‹è¯•ã€‚ <br/>
åŒæ—¶è¿˜å¯ä»¥å°†è™šæ‹Ÿæœºæ‰“åŒ…ï¼Œå¹¶å¤åˆ¶åˆ†å‘ç»™å…¶ä»–äººä½¿ç”¨ï¼Œè¿™æ ·èƒ½ä¿è¯æ‰€æœ‰å¼€å‘ç¯å¢ƒæ˜¯å®Œå…¨ä¸€è‡´ï¼Œ<br/>
æ— è®ºä»–ä»¬æ˜¯åœ¨ Linux è¿˜æ˜¯ Windows ä¸‹ï¼Œè¿˜æ˜¯ OSX ä¸‹ã€‚</p>

<h2>åŸºæœ¬æ“ä½œ</h2>

<p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œé€šè¿‡ <code>vagrant init {box_name}</code> å¯åˆå§‹åŒ–ä¸€åˆ‡åŸºæœ¬çš„é…ç½®ï¼Œå¹¶å†é€šè¿‡ <code>vagrant up</code> å³å¯å¯åŠ¨è™šæ‹Ÿæœºã€‚<br/></p>

<p>è‡³æ­¤ï¼Œå°±æ‹¥æœ‰äº†ä¸€ä¸ªåªä¸å½“å‰é¡¹ç›®ç›¸å…³çš„å®Œæ•´çš„è™šæ‹Ÿæœºç¯å¢ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ é€‰æ‹©çš„æ˜¯ ubuntu çš„è¯ï¼Œ<br/>
é‚£ä¹ˆä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ª ubuntu ç¯å¢ƒï¼Œé€šè¿‡<code>vagrant ssh</code>å³å¯ç™»é™†åˆ°è™šæ‹Ÿæœºã€‚</p>

<p>å¦å¤–ï¼Œå®ƒè¿˜ä¼šè‡ªåŠ¨åœ°æŠŠé¡¹ç›®ç›®å½•æŒ‚è½½åˆ°è™šæ‹Ÿæœºçš„ <code>/vagrant</code> ç›®å½•ä¸‹ï¼Œ<br/>
ä½ å½“å‰é¡¹ç›®ç›®å½•ä¸‹æ‰€æœ‰ç›®å½•æ–‡ä»¶ä¿®æ”¹ï¼Œéƒ½ä¼šå®æ—¶åé¦ˆåˆ°è™šæ‹Ÿæœºé‡Œã€‚</p>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ª rails é¡¹ç›®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨è™šæ‹Ÿæœºé‡Œï¼Œå¯åŠ¨ä¸€ä¸ª rails serverï¼Œ<br/>
å¹¶é€šè¿‡åœ¨ Vagrantfile é…ç½®æ–‡ä»¶é‡Œè®¾ç½®ç«¯å£æ˜ å°„ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æœ¬æœºçš„æµè§ˆå™¨ç›´æ¥è®¿é—®è™šæ‹Ÿæœºé‡Œçš„æœåŠ¡äº†ï¼Œ<br/>
è€Œå†™ä»£ç ï¼Œåˆ™å¯ä»¥åœ¨æˆ‘ä»¬çš„ä¸»æœºé‡Œå†™ï¼Œæƒ³æƒ³è¿˜æ˜¯æŒºé¸¡å†»çš„ ğŸ˜„ï¼ŒMac ç”¨æˆ·å¯ç›´æ¥æ— è§†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># å°†æœ¬æœºçš„3000ç«¯å£æ˜ å°„åˆ°è™šæ‹Ÿæœºé‡Œçš„3000ç«¯å£</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">3000</span>
</span></code></pre></td></tr></table></div></figure>


<p>å½“è™šæ‹Ÿæœºçš„ç¯å¢ƒè¢«æçƒ‚äº†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥<br/>
é€šè¿‡ <code>vagrant destroy</code> å³å¯åˆ é™¤ boxï¼Œå³è™šæ‹Ÿæœºã€‚<br/>
é€šè¿‡ <code>vagrant up</code> å³å¯é‡æ–°å¯åŠ¨ï¼Œå¹¶è½½å…¥å¹²å‡€çš„ boxã€‚</p>

<p>å½“æˆ‘ä»¬åœ¨è°ƒè¯• chef app çš„æ—¶å€™ï¼Œç»å¸¸å°±éœ€è¦è¿™ä¹ˆå¹²ï¼è¿™æ•´ä¸ªè¿‡ç¨‹ä¸€èˆ¬åœ¨ä¸€ä¸¤åˆ†é’Ÿå†…å³å¯å®Œæˆã€‚<br/>
å¹¶ä¸”å¦‚æœé€‰æ‹© Virtual Box ä½œä¸ºè™šæ‹Ÿæœºå¹³å°çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç¦ç”¨æ‰äº†çª—å£ï¼Œè¿™é…¸çˆ½å•Šï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># åœ¨ Vagrantfile é…ç½®æ–‡ä»¶é‡Œæ³¨é‡Šæ‰è¿™å‡ è¡Œä»£ç </span>
</span><span class='line'><span class="c1"># config.vm.provider :virtualbox do |vb|</span>
</span><span class='line'><span class="c1">#   # Don&#39;t boot with headless mode</span>
</span><span class='line'><span class="c1">#   vb.gui = true</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#   # Use VBoxManage to customize the VM. For example to change memory:</span>
</span><span class='line'><span class="c1">#   vb.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, &quot;1024&quot;]</span>
</span><span class='line'><span class="c1"># end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸‹é¢æ˜¯ vagrant çš„å…¨éƒ¨å‘½ä»¤ï¼Œé€šè¿‡ vagrant list-commands å³å¯è·å¾—ã€‚</p>

<pre><code>âœ  chef_pratice git:(master) vagrant list-commands
Below is a listing of all available Vagrant commands and a brief
description of what they do.

box             manages boxes: installation, removal, etc.
connect         connect to a remotely shared Vagrant environment
destroy         stops and deletes all traces of the vagrant machine
docker-logs     outputs the logs from the Docker container
docker-run      run a one-off command in the context of a container
global-status   outputs status Vagrant environments for this user
halt            stops the vagrant machine
help            shows the help for a subcommand
init            initializes a new Vagrant environment by creating a Vagrantfile
list-commands   outputs all available Vagrant subcommands, even non-primary ones
login           log in to HashiCorp's Atlas
package         packages a running vagrant environment into a box
plugin          manages plugins: install, uninstall, update, etc.
provision       provisions the vagrant machine
push            deploys code in this environment to a configured destination
rdp             connects to machine via RDP
reload          restarts vagrant machine, loads new Vagrantfile configuration
resume          resume a suspended vagrant machine
rsync           syncs rsync synced folders to remote machine
rsync-auto      syncs rsync synced folders automatically when files change
share           share your Vagrant environment with anyone in the world
ssh             connects to machine via SSH
ssh-config      outputs OpenSSH valid configuration to connect to the machine
status          outputs status of the vagrant machine
suspend         suspends the machine
up              starts and provisions the vagrant environment
version         prints current and latest Vagrant version
</code></pre>

<h3>References</h3>

<ul>
<li><a href="https://docs.vagrantup.com/v2/getting-started/index.html">Vagrant Doc</a></li>
<li><a href="http://www.vagrantbox.es/">Vagrant Boxes</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/10/kill-postgres-hang-query/">Kill Postgres Hang Query</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-10T16:20:05+08:00'><span class='date'>2014-12-10 16:20:05</span> <span class='time'>4:20 pm</span></time>
        
           | <a href="/blog/2014/12/10/kill-postgres-hang-query/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/12/10/kill-postgres-hang-query/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ä»Šå¤©ï¼Œåœ¨æœåŠ¡å™¨ä¸Šé¢æ‹‰äº†ä¸€ä»½æ•°æ®åï¼Œå¯¼å…¥äº†å•å¼ è¡¨çš„æ•°æ®ï¼Œä½†å‘ç°ç´¢å¼•éƒ½æ²¡æœ‰äº†ã€‚</p>

<p>äºæ˜¯å¼€äº†ä¸¤ä¸ª sessionï¼Œä¸¤è¾¹éƒ½è·‘åˆ›å»ºç´¢å¼•çš„ SQLï¼Œæ²¡æƒ³åˆ°è¿™æ—¶å€™ç«Ÿç„¶å‡ºç°äº† <code>deadlock detected</code> çš„é”™è¯¯ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ERROR:  deadlock detected
</span><span class='line'>DETAIL:  Process 18131 waits for ShareLock on virtual transaction 3/221; blocked by process 18295.
</span><span class='line'>Process 18295 waits for ShareUpdateExclusiveLock on relation 693783 of database 577626; blocked by process 18131.
</span><span class='line'>HINT:  See server log for query details.</span></code></pre></td></tr></table></div></figure>


<p>æŸ¥çœ‹æ•°æ®åº“çš„ pg_stat_activityï¼Œçœ‹çœ‹æœ‰å“ªäº› query åœ¨è¿›è¡Œã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT * from pg_stat_activity</span></code></pre></td></tr></table></div></figure>


<p>å¾—åˆ°çš„å…¶ä¸­ç›¸å…³çš„æ•°æ®</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>datid            | 577626
</span><span class='line'>datname          | test_db
</span><span class='line'>pid              | 18131
</span><span class='line'>usesysid         | 10
</span><span class='line'>usename          | John
</span><span class='line'>application_name | psql
</span><span class='line'>client_addr      |
</span><span class='line'>client_hostname  |
</span><span class='line'>client_port      | -1
</span><span class='line'>backend_start    | 2014-12-10 15:48:28.064723+08
</span><span class='line'>xact_start       | 2014-12-10 16:23:59.189095+08
</span><span class='line'>query_start      | 2014-12-10 16:23:59.189095+08
</span><span class='line'>state_change     | 2014-12-10 16:23:59.189098+08
</span><span class='line'>waiting          | t
</span><span class='line'>state            | active
</span><span class='line'>query            | CREATE INDEX index_events_on_source_event ON events USING btree (source_event);</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥å‘ç°ï¼Œè¿™ä¸ª query ä¸€ç›´å¤„äºç­‰å¾…çš„çŠ¶æ€ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯ç§»é™¤è¿™ä¸ª query å°±å¥½äº†ã€‚</p>

<p>æ‰“å¼€å¦å¤–ä¸€ä¸ªç»ˆç«¯ï¼Œæ‰§è¡Œ <code>ps -ef | grep postgres</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>âœ  ~  ps -ef | grep postgres
</span><span class='line'>  501   642   357   0  9:58PM ??         0:03.91 postgres: checkpointer process
</span><span class='line'>  501   643   357   0  9:58PM ??         0:00.70 postgres: writer process
</span><span class='line'>  501   644   357   0  9:58PM ??         0:02.41 postgres: wal writer process
</span><span class='line'>  501   645   357   0  9:58PM ??         0:02.68 postgres: autovacuum launcher process
</span><span class='line'>  501   646   357   0  9:58PM ??         0:05.16 postgres: stats collector process
</span><span class='line'>  501 18131   357   0  3:48PM ??         7:36.41 postgres: John test_db [local] idle
</span><span class='line'>  501 18295   357   0  3:54PM ??        12:46.07 postgres: John test_db [local] CREATE INDEX
</span><span class='line'>  501 18963 18753   0  4:16PM ttys000    0:00.00 grep postgres</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ—¶å€™å°±çœ‹åˆ°äº† <code>CREATE INDEX</code>ï¼Œå¹²æ‰è¿™ä¸ªè¿›ç¨‹å°±å¯ä»¥äº†ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kill -TERM 18295</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/06/minitest/">Stub and Mock in Minitest</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-06T20:32:48+08:00'><span class='date'>2014-11-06 20:32:48</span> <span class='time'>8:32 pm</span></time>
        
           | <a href="/blog/2014/11/06/minitest/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/11/06/minitest/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Stubs å’Œ Mocks åœ¨å†™æµ‹è¯•æ—¶ï¼Œç»å¸¸ä¼šéœ€è¦ç”¨åˆ°ï¼Œ
è€Œ minitestï¼ˆ5.4.xï¼‰ æ–‡æ¡£åœ¨è¿™ä¸¤ä¸ªåœ°æ–¹æœ‰ç‚¹éš¾æ‡‚ã€‚</p>

<p>å®˜æ–¹çš„å¯¹ Stub çš„å®ç°å¾ˆå¼±ï¼ŒåŸºæœ¬ä¸å¯ç”¨ï¼Œ
æœ‰ä¸ª <em>minitest-stub_any_instance</em> æ‰©å±•å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼Œ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install minitest-stub_any_instance -v '1.0.0'</span></code></pre></td></tr></table></div></figure>


<p>æ¥çœ‹ä¾‹å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;minitest/autorun&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;minitest/stub_any_instance&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Book</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="nb">name</span><span class="p">;</span> <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">name</span><span class="p">;</span> <span class="vi">@name</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">Book</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;stub example&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Book</span><span class="o">.</span><span class="n">stub_any_instance</span> <span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;Computer Systems&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;SICP&quot;</span>
</span><span class='line'>      <span class="n">book</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">must_equal</span> <span class="s2">&quot;Computer Systems&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>è€Œå¯¹äº mockï¼Œå®˜æ–¹çš„å®ç°ä¸é”™ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;minitest/autorun&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Book</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="nb">name</span><span class="p">;</span> <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">name</span><span class="p">;</span> <span class="vi">@name</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">Book</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;mock example&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">book</span> <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Mock</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">book</span><span class="o">.</span><span class="n">expect</span> <span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;Computer Systems&quot;</span>
</span><span class='line'>    <span class="n">book</span><span class="o">.</span><span class="n">expect</span> <span class="ss">:price</span><span class="p">,</span> <span class="mi">100</span>
</span><span class='line'>    <span class="n">book</span><span class="o">.</span><span class="n">expect</span> <span class="ss">:can_buy?</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="o">[</span><span class="mi">80</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">book</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">must_equal</span> <span class="s2">&quot;Computer Systems&quot;</span>
</span><span class='line'>    <span class="n">book</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">must_equal</span> <span class="mi">100</span>
</span><span class='line'>    <span class="n">book</span><span class="o">.</span><span class="n">can_buy?</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
</span><span class='line'>    <span class="n">book</span><span class="o">.</span><span class="n">verify</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://docs.seattlerb.org/minitest/Minitest/Mock.html#method-i-expect">å®˜æ–¹çš„æ–‡æ¡£</a>é‡Œæœ‰ <code>expect</code> å’Œ <code>verify</code> è¿™ä¸¤ä¸ªå‡½æ•°çš„æ–‡æ¡£ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/04/tree-data/">Tree Data</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-04T12:50:00+08:00'><span class='date'>2014-11-04 12:50:00</span> <span class='time'>12:50 pm</span></time>
        
           | <a href="/blog/2014/11/04/tree-data/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/11/04/tree-data/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>å¯¹äºæ ‘å½¢ç»“æ„çš„æ•°æ®å­˜å‚¨ï¼Œschema çš„è®¾è®¡é€šå¸¸å¾ˆç®€å•ï¼Œéš¾çš„æ˜¯å…¶æŸ¥è¯¢æ˜¯å¦ç®€å•ã€æ–¹ä¾¿ã€‚<br/>
è¿™é‡Œæˆ‘æ‰€é€‰ç”¨çš„æ•°æ®åº“ä¸ºï¼šPostgreSQLï¼Œç‰ˆæœ¬ä¸ºï¼š<code>9.3.5</code>ã€‚</p>

<h2>æ•°æ®ç»“æ„è®¾è®¡</h2>

<p>å¯¹äºæ ‘å½¢ç»“æ„æ•°æ®çš„å­˜å‚¨ï¼Œå¦‚ä¸€ä¸ªä¼ä¸šçš„éƒ¨é—¨ï¼Œschema é€šå¸¸è®¾è®¡æˆè¿™æ ·å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>   <span class="k">Column</span>   <span class="o">|</span>            <span class="k">Type</span>             <span class="o">|</span>                        <span class="n">Modifiers</span>
</span><span class='line'><span class="c1">------------+-----------------------------+----------------------------------------------------------</span>
</span><span class='line'> <span class="n">id</span>         <span class="o">|</span> <span class="nb">integer</span>                     <span class="o">|</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="n">nextval</span><span class="p">(</span><span class="s1">&#39;departments_id_seq&#39;</span><span class="p">::</span><span class="n">regclass</span><span class="p">)</span>
</span><span class='line'> <span class="n">name</span>       <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>      <span class="o">|</span>
</span><span class='line'> <span class="n">parent_id</span>  <span class="o">|</span> <span class="nb">integer</span>                     <span class="o">|</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç†è®ºä¸Šï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æ”¯æŒæ— é™çº§ï¼Œä½†ï¼Œè¿™é‡Œæˆ‘ä¸é’ˆå¯¹è¿™ç§è®¾è®¡åšè®¨è®ºã€‚</p>

<h2>ancestryï¼Œa rails gem</h2>

<p>å®˜æ–¹çš„ä¸€å¥è¯ä»‹ç»</p>

<blockquote><p>Organise ActiveRecord model into a tree structure</p></blockquote>

<p>RUBY æœ‰å‡ ä¸ªä¸“é—¨å¤„ç†æ ‘å½¢ç»“æ„çš„ GEMï¼Œä¸Š <a href="https://www.ruby-toolbox.com/projects/ancestry">RUBY TOOLBOX</a> ä¸€æœå°±å¯çŸ¥é“æœ‰å“ªäº›ã€‚<br/>
å› ä¸ºå…¬å¸é¡¹ç›®é‡Œé‡‡ç”¨äº† <a href="https://github.com/stefankroes/ancestry">ancestry</a>ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿåªæ˜¯åˆ†äº«åœ¨è¿™æ–¹é¢çš„å®è·µã€‚</p>

<p>é‡‡ç”¨ ancestry åï¼Œæˆ‘ä»¬çš„è¡¨ schema å˜æˆï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>   <span class="k">Column</span>   <span class="o">|</span>            <span class="k">Type</span>             <span class="o">|</span>                        <span class="n">Modifiers</span>
</span><span class='line'><span class="c1">------------+-----------------------------+----------------------------------------------------------</span>
</span><span class='line'> <span class="n">id</span>         <span class="o">|</span> <span class="nb">integer</span>                     <span class="o">|</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="n">nextval</span><span class="p">(</span><span class="s1">&#39;departments_id_seq&#39;</span><span class="p">::</span><span class="n">regclass</span><span class="p">)</span>
</span><span class='line'> <span class="n">name</span>       <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>      <span class="o">|</span>
</span><span class='line'> <span class="n">ancestry</span>   <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>      <span class="o">|</span>
</span><span class='line'><span class="n">Indexes</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">&quot;departments_id_pkey&quot;</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="ss">&quot;departments_ancestry&quot;</span> <span class="n">btree</span> <span class="p">(</span><span class="n">ancestry</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯ä¸€äº› Demo Dataï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="n">id</span>  <span class="o">|</span>     <span class="n">name</span>     <span class="o">|</span> <span class="n">ancestry</span>
</span><span class='line'><span class="c1">------+--------------+----------</span>
</span><span class='line'>    <span class="mi">1</span> <span class="o">|</span> <span class="n">root</span>        <span class="o">|</span>
</span><span class='line'>    <span class="mi">2</span> <span class="o">|</span> <span class="err">äº§å“ç ”å‘ä¸­å¿ƒ</span>  <span class="o">|</span> <span class="mi">1</span>
</span><span class='line'>    <span class="mi">5</span> <span class="o">|</span> <span class="err">ç ”å‘éƒ¨</span>       <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'>    <span class="mi">6</span> <span class="o">|</span> <span class="err">äº§å“éƒ¨</span>       <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'>   <span class="mi">11</span> <span class="o">|</span> <span class="err">è¿è¥éƒ¨</span>       <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'>   <span class="mi">12</span> <span class="o">|</span> <span class="err">å†…å®¹å¼€å‘ä¸­å¿ƒ</span>  <span class="o">|</span> <span class="mi">1</span>
</span><span class='line'>   <span class="mi">13</span> <span class="o">|</span> <span class="err">å†…å®¹éƒ¨</span>       <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">12</span>
</span><span class='line'>   <span class="mi">15</span> <span class="o">|</span> <span class="err">è§†é¢‘éƒ¨</span>       <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">12</span>
</span><span class='line'>   <span class="mi">16</span> <span class="o">|</span> <span class="err">è¡Œæ”¿ä¸­å¿ƒ</span>     <span class="o">|</span> <span class="mi">1</span>
</span><span class='line'>   <span class="mi">19</span> <span class="o">|</span> <span class="err">è´¢åŠ¡éƒ¨</span>       <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span>
</span><span class='line'>   <span class="mi">21</span> <span class="o">|</span> <span class="err">äººåŠ›èµ„æºéƒ¨</span>   <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span>
</span><span class='line'>   <span class="mi">25</span> <span class="o">|</span> <span class="err">è¡Œæ”¿éƒ¨</span>      <span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span>
</span><span class='line'>    <span class="mi">8</span> <span class="o">|</span> <span class="err">å“ç‰Œå¸‚åœºä¸­å¿ƒ</span> <span class="o">|</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç”¨å­—ç¬¦ä¸²ç±»å‹çš„ ancestry å­—æ®µç±»æ›¿ä»£å¸¸ç”¨çš„ parent_idï¼Œç”¨ä»¥è¯´æ˜å®ƒä»æ ¹ç»“ç‚¹åˆ°å®ƒçš„ç›´æ¥çˆ¶ç»“ç‚¹çš„è·¯å¾„ã€‚<br/>
ä¾‹å¦‚ï¼šid ä¸º 11 çš„è®°å½•ï¼Œancestry çš„å€¼ä¸º <code>1/2</code>ï¼Œå®ƒçš„çˆ¶ç»“ç‚¹çš„è·¯å¾„ä¸ºï¼š<code>root/äº§å“ç ”å‘ä¸­å¿ƒ</code>ã€‚</p>

<p>ä½¿ç”¨è¿™ç§è§„åˆ™ï¼Œä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æŸ¥è¯¢ä¸€äº›æ•°æ®ï¼Œå¦‚äº§å“ç ”å‘ä¸­å¿ƒè¿™ä¸ªèŠ‚ç‚¹ä¸‹é¢çš„æ‰€æœ‰å­ç»“ç‚¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">departments</span> <span class="k">WHERE</span> <span class="n">ancestry</span> <span class="k">LIKE</span> <span class="s1">&#39;1/%&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ancestry æä¾›äº†ä¸€äº›å¥½ç”¨çš„å‡½æ•°ï¼Œè®©ä½ èƒ½å¤Ÿç›´æ¥åšä¸€äº›æ•°æ®æŸ¥è¯¢ã€‚<a href="https://github.com/stefankroes/ancestry#navigating-your-tree">ä¹–ï¼Œç‚¹è¿™é‡Œ</a></p>

<h2>arrange_serializable</h2>

<p>ancestry æä¾›çš„ <code>arrange_serializable</code> æ–¹æ³•ï¼Œå¯ä»¥å°†æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ï¼Œè½¬æ¢æˆæ•°æ®ç»“æ„çš„æ•°æ®ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Department</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">client_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arrange_serializable</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[{</span>
</span><span class='line'>    <span class="err">id:</span> <span class="err">1,</span>
</span><span class='line'>    <span class="err">name:</span> <span class="nt">&quot;root&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">children:</span> <span class="err">[</span>
</span><span class='line'>        <span class="err">{</span> <span class="err">id:</span> <span class="err">2,</span> <span class="err">name:</span> <span class="nt">&quot;äº§å“ç ”å‘ä¸­å¿ƒ&quot;</span><span class="p">,</span> <span class="err">children:</span> <span class="err">[{...</span><span class="p">},{</span><span class="err">...</span><span class="p">}]</span> <span class="err">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="err">id:</span> <span class="err">12,</span> <span class="err">name:</span> <span class="nt">&quot;å†…å®¹å¼€å‘ä¸­å¿ƒ&quot;</span><span class="p">,</span> <span class="err">children:</span> <span class="err">[{...</span><span class="p">}</span><span class="err">,</span><span class="p">{</span><span class="err">...</span><span class="p">}</span><span class="err">]</span> <span class="err">}</span>
</span><span class='line'>    <span class="err">]</span>
</span><span class='line'><span class="err">},</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">#...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ä½¿ç”¨æ•°æ®åº“å‡½æ•°å®ç°</h2>

<p>é™¤äº†ä¸Šé¢ ancestry æ‰€æä¾›çš„æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ•°æ®åº“é‡Œåˆ›å»º <code>FUNCTION</code>ï¼Œè®©å…¶èƒ½å¤Ÿå»æ”¶é›†ä¸€ä¸ªç»“ç‚¹çš„å­ç»“ç‚¹çš„æ•°æ®ã€‚<br/>
ä½¿ç”¨ <code>PL/pgSQL</code> è„šæœ¬ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span> (select_subtree.sql)</span> <a href='/downloads/code/20141104/select_subtree.sql'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- åˆ›å»ºè·å–å­èŠ‚ç‚¹çš„å‡½æ•°</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">collect_childs_func</span><span class="p">(</span><span class="n">dept_id</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">ancestry</span> <span class="nb">CHARACTER</span> <span class="nb">VARYING</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span> <span class="k">RETURNS</span> <span class="nb">TEXT</span> <span class="k">AS</span> <span class="err">$$</span>
</span><span class='line'><span class="k">DECLARE</span>
</span><span class='line'>  <span class="c1">-- åˆå§‹åŒ–å˜é‡</span>
</span><span class='line'>  <span class="n">child_ancestry</span> <span class="nb">CHARACTER</span> <span class="nb">VARYING</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span><span class='line'>  <span class="n">dept</span> <span class="n">RECORD</span><span class="p">;</span>
</span><span class='line'>  <span class="n">children</span> <span class="nb">TEXT</span><span class="p">;</span>
</span><span class='line'>  <span class="n">childs</span> <span class="nb">TEXT</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">&#39;{}&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>  <span class="c1">-- å¾—åˆ°æŸ¥å­èŠ‚ç‚¹çš„ ancestry å˜é‡</span>
</span><span class='line'>  <span class="n">IF</span> <span class="n">ancestry</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span>
</span><span class='line'>    <span class="n">child_ancestry</span> <span class="p">:</span><span class="o">=</span> <span class="n">dept_id</span><span class="p">;</span>
</span><span class='line'>  <span class="k">ELSE</span>
</span><span class='line'>    <span class="n">child_ancestry</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">ancestry</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span> <span class="o">||</span> <span class="n">dept_id</span><span class="p">);</span>
</span><span class='line'>  <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">-- æŸ¥è¯¢å…¶å­éƒ¨é—¨</span>
</span><span class='line'>  <span class="k">FOR</span> <span class="n">dept</span> <span class="k">IN</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">departments</span> <span class="k">WHERE</span> <span class="n">departments</span><span class="p">.</span><span class="n">ancestry</span> <span class="o">=</span> <span class="n">child_ancestry</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">departments</span><span class="p">.</span><span class="n">id</span> <span class="n">LOOP</span>
</span><span class='line'>    <span class="n">IF</span> <span class="n">dept</span><span class="p">.</span><span class="n">ancestry</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span>
</span><span class='line'>      <span class="n">childs</span> <span class="p">:</span><span class="o">=</span> <span class="n">ARRAY_APPEND</span><span class="p">(</span><span class="n">childs</span><span class="p">,</span> <span class="s1">&#39;{ &quot;id&quot;: &#39;</span> <span class="o">||</span> <span class="n">dept</span><span class="p">.</span><span class="n">id</span> <span class="o">||</span> <span class="s1">&#39;, &quot;name&quot;: &quot;&#39;</span> <span class="o">||</span> <span class="n">dept</span><span class="p">.</span><span class="n">name</span> <span class="o">||</span> <span class="s1">&#39;&quot;, &quot;children&quot;: []}&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">ELSE</span>
</span><span class='line'>      <span class="n">childs</span> <span class="p">:</span><span class="o">=</span> <span class="n">ARRAY_APPEND</span><span class="p">(</span><span class="n">childs</span><span class="p">,</span> <span class="s1">&#39;{ &quot;id&quot;: &#39;</span> <span class="o">||</span> <span class="n">dept</span><span class="p">.</span><span class="n">id</span> <span class="o">||</span> <span class="s1">&#39;, &quot;name&quot;: &quot;&#39;</span> <span class="o">||</span> <span class="n">dept</span><span class="p">.</span><span class="n">name</span> <span class="o">||</span> <span class="s1">&#39;&quot;, &quot;children&quot;:&#39;</span> <span class="o">||</span> <span class="n">collect_childs_func</span><span class="p">(</span><span class="n">dept</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dept</span><span class="p">.</span><span class="n">ancestry</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;}&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class='line'>  <span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">children</span> <span class="p">:</span><span class="o">=</span> <span class="n">ARRAY_TO_STRING</span><span class="p">(</span><span class="n">childs</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">children</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">||</span> <span class="n">children</span> <span class="o">||</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">RETURN</span> <span class="n">children</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span><span class="p">;</span>
</span><span class='line'><span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span>
</span></code></pre></td></tr></table></div></figure>


<p>é€šè¿‡ <code>psql -d dbname</code> æ‰“å¼€ä¸€ä¸ªä¼šè¯ï¼ˆå³è¿æ¥åˆ°æ•°æ®åº“ï¼‰ï¼Œæ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åˆšåˆ›å»ºçš„ <code>FUNCTION</code> äº†
å¦‚ä¸‹ï¼ˆé¡¹ç›®é‡Œçš„ departments è¡¨å®é™…è¿˜æœ‰ä¸€ä¸ª <code>client_id</code> å­—æ®µï¼‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">collect_childs_func</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">NULL</span><span class="p">)</span> <span class="k">AS</span> <span class="n">children</span> <span class="k">FROM</span> <span class="n">departments</span> <span class="k">WHERE</span> <span class="n">client_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">ancestry</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å‡ºæ¥çš„ç»“æœå¤§æ¦‚æ˜¯è¿™æ ·å­çš„ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">id</span>       <span class="o">|</span> <span class="mi">1</span>
</span><span class='line'><span class="n">name</span>     <span class="o">|</span> <span class="n">root</span>
</span><span class='line'><span class="n">children</span> <span class="o">|</span> <span class="p">[</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;äº§å“ç ”å‘ä¸­å¿ƒ&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;ç ”å‘éƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;äº§å“éƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;è¿è¥éƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;å“ç‰Œå¸‚åœºä¸­å¿ƒ&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;å†…å®¹å¼€å‘ä¸­å¿ƒ&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;å†…å®¹éƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;è§†é¢‘éƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;è¡Œæ”¿ä¸­å¿ƒ&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;è´¢åŠ¡éƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;äººåŠ›èµ„æºéƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;è¡Œæ”¿éƒ¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6237</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;æ–°å¢éƒ¨é—¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6238</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;æ–°å¢éƒ¨é—¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;ä½“éªŒå®¢æˆ·&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2597</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;ä¸“å®¶ç»„&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5846</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;æµ‹è¯•éƒ¨é—¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">,</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6390</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;è´¨æ£€éƒ¨é—¨&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[</span><span class="err">{</span> <span class="ss">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6391</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;è´¨æ£€ä¸€ç»„&quot;</span><span class="p">,</span> <span class="ss">&quot;children&quot;</span><span class="p">:[]</span><span class="err">}</span><span class="p">]</span><span class="err">}</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¾—åˆ°çš„ children æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œåªéœ€è¦ç®€å• parse ä¸€ä¸‹ï¼Œæˆ–è€…ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯å³å¯ã€‚</p>

<p><strong>åˆ é™¤</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">collect_childs_func</span><span class="p">(</span><span class="n">dept_id</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">ancestry</span> <span class="nb">CHARACTER</span> <span class="nb">VARYING</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>åº”ç”¨åˆ° production</strong></p>

<p>å› ä¸ºåˆ›å»ºå‡½æ•°éœ€è¦è¾ƒé«˜çš„æƒé™ï¼Œæ‰€ä»¥ä¸ºé¿å…é”™è¯¯ï¼Œç›´æ¥åœ¨çº¿ä¸Šçš„æ•°æ®åº“è·‘ä¸€ä¸‹ä»£ç å³å¯ï¼Œè€Œä¸è¦å†™åœ¨ migration é‡Œï¼Œç„¶ååœ¨é¡¹ç›®æ–‡æ¡£é‡Œå†™ä¸€ä¸‹è¯´æ˜å³å¯ã€‚
å¦‚æœä½ çš„é¡¹ç›®çš„æ•°æ®åº“æœ‰å¾ˆå¤šå°ï¼Œå°±å†å»è€ƒè™‘è‡ªåŠ¨åŒ–çš„äº‹æƒ…å°±å¥½äº†ã€‚</p>

<h2>References</h2>

<ul>
<li><a href="http://www.cnblogs.com/yuyang-DataAnalysis/archive/2013/03/25/2981154.html">http://www.cnblogs.com/yuyang-DataAnalysis/archive/2013/03/25/2981154.html</a></li>
<li><a href="http://www.postgresql.org/docs/9.3/static/functions.html">http://www.postgresql.org/docs/9.3/static/functions.html</a></li>
<li><a href="http://www.postgresql.org/docs/9.1/static/sql-createaggregate.html">http://www.postgresql.org/docs/9.1/static/sql-createaggregate.html</a></li>
<li><a href="http://www.felixgers.de/teaching/sql/sql_custom_aggregate.html">http://www.felixgers.de/teaching/sql/sql_custom_aggregate.html</a></li>
<li><a href="http://www.cottinghams.com/david/aggregatePlPerl.shtml">http://www.cottinghams.com/david/aggregatePlPerl.shtml</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/04/about-computer/">About Computer</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-04T12:49:44+08:00'><span class='date'>2014-11-04 12:49:44</span> <span class='time'>12:49 pm</span></time>
        
           | <a href="/blog/2014/11/04/about-computer/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/11/04/about-computer/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>åœ¨äº’è”ç½‘å¼€å§‹å´›èµ·çš„æ—¶å€™ï¼Œã€Œå­¦ä¹ ã€å’Œã€Œæ²Ÿé€šã€æ˜¯äººä»¬ä½¿ç”¨ç”µè„‘çš„ä¸»æ—‹å¾‹ã€‚<br/>
è€Œåˆ°äº†ä»Šå¤©ï¼Œæˆ‘ä»¬é™¤äº†è¿™ä¸¤æ ·ï¼Œåˆå¢åŠ äº†ã€Œå·¥ä½œã€ã€ã€Œå¨±ä¹ã€è¿™ä¸¤ä¸ªæ—‹å¾‹ã€‚</p>

<p>è€Œæˆ‘æœ€ç–‘æƒ‘çš„æ—¶ï¼Œåœ¨ä»Šå¤©çš„æ—¶ä»£é‡Œï¼Œæˆ‘ä»¬åœ¨è¿™å››è€…çš„åˆ†é…åˆ†åˆ«æ˜¯å¦‚ä½•çš„ï¼Œå¹¶ä¸”å…¶æ•ˆç‡æœ‰åˆ†åˆ«æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ<br/>
è€Œè¿™äº›åˆæ˜¯å¦æ˜¯æˆ‘ä»¬æ´»ç€æ‰€å¿…é¡»çš„ï¼Œåˆæˆ–è€…è¯´ï¼Œéš¾é“å°±æ²¡æœ‰å…¶ä»–æ´»ç€çš„æ–¹å¼ä¹ˆï¼Ÿ</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/18/about-code-refactoring/">Code Refactoring</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-18T17:46:10+08:00'><span class='date'>2014-05-18 17:46:10</span> <span class='time'>5:46 pm</span></time>
        
           | <a href="/blog/2014/05/18/about-code-refactoring/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/05/18/about-code-refactoring/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>æ— è®ºæ˜¯ä»£ç çš„ç¼–å†™è€…è¿˜æ˜¯é˜…è¯»è€…ï¼Œå¯¹äºä¸€æ®µç¨‹åºæœ¬èº«å°±æœ‰å¾ˆå¼ºçš„ä¸»è§‚æ€§ã€‚<br>
ä»£ç è´¨é‡çš„è¯„åˆ¤ï¼Œå†³å®šäºä»£ç é˜…è¯»è€…çš„æ°´å¹³è€Œéä»£ç ç¼–å†™è€…ï¼Œå› ä¸ºæœ¬æ¥å°±æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ‡å‡†ã€‚</p>

<h2>ä¸ºä½•è¦è¿›è¡Œä»£ç é‡æ„</h2>

<ol>
<li>å·²æœ‰çš„ä»£ç éšç€æ•°æ®çš„å¢é•¿æˆ–è€…ç¯å¢ƒçš„å˜æ›´è€Œæš´éœ²å‡ºçš„BUG</li>
<li>å·²æœ‰çš„ä»£ç æ— æ³•å¾ˆå¥½åœ°æ”¯æ’‘èµ·æ–°çš„éœ€æ±‚</li>
<li>å¯¹å·²æœ‰ä»£ç çš„æåº¦ä¸æ»¡ï¼Œè®©ä½ å¾ˆä¸çˆ½</li>
</ol>


<h2>é‡æ„æˆåŠŸä¸å¦çš„æ ‡å‡†</h2>

<p><strong>å¯¹äºå…¬å¸æ¥è¯´</strong></p>

<p>ä¸å‡ºé”™ï¼Ÿä»€ä¹ˆäº‹æƒ…ä¹Ÿä¸ä¼šå‘ç”Ÿã€‚<br>
å‡ºé”™äº†ï¼Ÿä½ å¹²äº†ä¸€ä»¶éå¸¸æ„šè ¢åæœéå¸¸ä¸¥é‡çš„äº‹æƒ…!!!</p>

<p><strong>å¯¹äºé¡¹ç›®æ¥è¯´</strong></p>

<p>ä¸å‡ºé”™ï¼Ÿä½ å¹²äº†ä¸€ä»¶ä¸é”™çš„äº‹æƒ…ã€‚<br>
å‡ºé”™äº†ï¼Ÿä½ æ€ä¹ˆé‚£ä¹ˆå¤šäº‹ï¼</p>

<p>æ— è®ºä½ åœ¨è¿™æ¬¡é‡æ„ä¸­ä»˜å‡ºäº†å¤šå°‘å¿ƒè¡€ï¼Œå¤šå°‘ä¸ªå¤œæ™šçš„å¥‹æ–—ï¼Œ
åˆæˆ–è€…æœ¬æ¥å°±ä¸å…³ä½ çš„äº‹ç„¶åä½ ä¸ºäº†é¡¹ç›®é‡Œèƒ½æœ‰æ›´å¥½çš„ä»£ç ä½ ä¸»åŠ¨ä»˜å‡ºäº†è®¸å¤šä¸ªå°æ—¶çš„å¥‹æ–—ï¼Œ
ä½ è¿˜æ˜¯é”™çš„ã€‚</p>

<p><strong>å¯¹äºä¸ªäººæ¥è¯´</strong></p>

<p>ä¸å‡ºé”™ï¼Ÿä½ è§‰å¾—çˆ½äº†ã€é«˜å…´äº†å°±æ˜¯æˆåŠŸçš„ã€‚<br>
å‡ºé”™äº†ï¼Ÿä½ è§‰å¾—çˆ½äº†ã€é«˜å…´äº†å°±æ˜¯æˆåŠŸçš„ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/18/buy-a-fkbn87m-slash-eb2-majestouch-2/">Buy a Mechanical Keyboard</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-18T17:04:58+08:00'><span class='date'>2014-05-18 17:04:58</span> <span class='time'>5:04 pm</span></time>
        
           | <a href="/blog/2014/05/18/buy-a-fkbn87m-slash-eb2-majestouch-2/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/05/18/buy-a-fkbn87m-slash-eb2-majestouch-2/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>åœ¨é•¿è¾¾ä¸€ä¸ªæœˆçš„çŠ¹è±«çº ç»“é‡Œï¼Œä¸Šå‘¨ç»ˆäºä¸‹å®šå†³å¿ƒåœ¨äº¬ä¸œä¸Šä¹°äº†<a href="http://item.jd.com/959148.html">æ–å°”å¯ï¼ˆFILCOï¼‰ FKBN87M/EB2 Majestouch 2ã€Œ87åœ£æ‰‹äºŒä»£ã€é»‘è‰²èŒ¶è½´ æœºæ¢°é”®ç›˜</a>ã€‚</p>

<p><img src="/downloads/images/flico_87.jpg"></p>

<p>æœºæ¢°é”®ç›˜ä¸€èˆ¬æœ‰å››ç§è½´å¿ƒï¼šé»‘è½´ã€çº¢è½´ã€èŒ¶è½´ã€é’è½´ã€‚é»‘è½´æ‰“å­—å£°éŸ³è¾ƒå°ï¼Œçº¢è½´è·Ÿé»‘è½´ç±»ä¼¼ï¼ŒèŒ¶è½´æœ‰è½»å¾®çš„æ®µè½æ„Ÿï¼Œé’è½´æ®µè½æ„Ÿæœ€å¼ºã€‚æˆ‘çš„æƒ³æ³•æ˜¯æ—¢ç„¶ä¹°æœºæ¢°é”®ç›˜ï¼Œå½“ç„¶è¦ä¹°æ®µè½æ„Ÿæ¯”è¾ƒå¼ºçš„ï¼Œè¿™æ ·æ•²èµ·æ¥ä¹Ÿå¾ˆçˆ½ï¼Œä½†æ˜¯ä¹‹æ‰€ä»¥é€‰æ‹©äº†èŒ¶è½´è€Œä¸æ˜¯é’è½´ï¼Œæ˜¯å› ä¸ºä¸æƒ³åœ¨ä¸Šç­æ—¶è¢«æ—è¾¹çš„åŒäº‹æ‰“ã€‚<a href="http://www.pcviva.com/dazishengyin.html">å‡ ç§è½´å¿ƒçš„å£°éŸ³å¯ä»¥åˆ°è¿™é‡Œå»è¯•å¬ä¸€ä¸‹</a>ã€‚</p>

<p>å¦å¤–å› ä¸ºç”¨çš„æ˜¯ Macbook Proï¼Œå†åŠ ä¸Šæ­¤æ¬¾é”®ç›˜ä»¥é€‚åº” windows ç³»ç»Ÿä¸ºä¸»ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬å°†è¿™ä¸ªUSBå¤–ç½®é”®ç›˜çš„altå’Œwiné”®åè¿‡æ¥ï¼Œè¿™æ ·åœ¨OSXä¸‹ä½¿ç”¨èµ·æ¥æ‰ä¼šæ¯”è¾ƒèˆ’æœç‚¹ã€‚</p>

<p>è¿™æ¬¾é”®ç›˜å±äºåƒå…ƒä»¥å†…çš„ï¼Œå½“ç„¶æ¯”ä¸ä¸Š<a href="http://thekaiway.com/2012/08/01/got-a-hhkb-pro2">HHKB Pro2</a>ï¼Œä½†æ˜¯ç›¸å¯¹æ™®é€šé”®ç›˜æ¥è¯´ï¼Œæ•²å‡»æ‰€å¸¦æ¥çš„æ„Ÿè§‰è¿˜æ˜¯æœ‰éå¸¸å¤§çš„ä¸åŒçš„ã€‚ä¸è¿‡æœ‰èƒ½åŠ›çš„è¯è¿˜æ˜¯å»è´­ä¹°ä¸€ä¸ªæ›´å¥½çš„æœºæ¢°é”®ç›˜ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/18/working-with-timezone-in-rails-03/">Working With Timezone in Rails(03)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-18T16:17:30+08:00'><span class='date'>2014-05-18 16:17:30</span> <span class='time'>4:17 pm</span></time>
        
           | <a href="/blog/2014/05/18/working-with-timezone-in-rails-03/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/05/18/working-with-timezone-in-rails-03/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>å‰é¢ä¸¤ç¯‡åˆ†åˆ«é˜è¿°äº†æ•°æ®åº“å¯¹æ—¶åŒºçš„ä¸åŒå¤„ç†å¤„ç†æ–¹å¼å’ŒRailsä¸­æœ‰å…³æ—¶åŒºçš„ä¸¤ä¸ªé€‰é¡¹è®¾ç½®ã€‚
è¿™ç¯‡ä¸»è¦é˜è¿°åœ¨ä¸åŒæ•°æ®åº“å¯¹æ—¶åŒºä¸åŒçš„æ”¯æŒæƒ…å†µä¸‹ï¼ŒRailsé¡¹ç›®é‡Œæ”¹å¦‚ä½•å»é€‰æ‹©æ—¶åŒºã€‚</p>

<h2>ä¸æ”¯æŒæ—¶åŒº</h2>

<p>è¿™é‡Œè¯´çš„ <code>ä¸æ”¯æŒæ—¶åŒº</code> æ˜¯æŒ‡æ•°æ®åº“è¡¨é‡Œçš„å­—æ®µæ²¡æœ‰æ—¶åŒºçš„æ¦‚å¿µï¼Œå¦‚ MySQL5.5 ç‰ˆæœ¬ã€‚</p>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœé¡¹ç›®ä½¿ç”¨äººç¾¤æ˜¯è·¨æ—¶åŒºçš„ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾åœ°ï¼Œåœ¨æ—¥æœŸæ•°æ®çš„å­˜å‚¨å’Œæ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥ä½¿ç”¨ UTC æ—¶åŒºï¼Œè€Œæ—¥æœŸæ•°æ®çš„æ˜¾ç¤ºå†æ ¹æ®æœ¬åœ°çš„æ—¶åŒºå»æ˜¾ç¤ºã€‚</p>

<p>å¦‚æœé¡¹ç›®çš„ä½¿ç”¨äººç¾¤å¹¶ä¸è·¨æ—¶åŒºï¼ˆæˆ–ç€ç›¸å½“é•¿çš„ä¸€æ®µæ—¶é—´å†…æ˜¯ç¡®å®šä¸è·¨æ—¶åŒºçš„ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„é€‰æ‹©å°±æ¯”è¾ƒè‡ªç”±äº†ã€‚æ—¥æœŸæ•°æ®çš„å­˜å‚¨å’Œæ“ä½œå¯ä»¥ä½¿ç”¨ UTCï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼Œè€Œæ˜¾ç¤ºçš„æ—¶å€™ï¼Œç»Ÿä¸€ç”¨æœ¬åœ°æ—¶åŒºå»æ˜¾ç¤ºã€‚
ä¸è¿‡å»ºè®®éƒ½ç»Ÿä¸€é‡‡ç”¨æœ¬åœ°æ—¶åŒºï¼Œè¿™æ ·èƒ½é¿å…åœ¨å¼€å‘è¿‡ç¨‹ä¸­å‡ºç°çš„è®¤ä¸ºé”™è¯¯ï¼Œå¦‚è‡ªå·±æ‹¼å†™SQLã€ä½¿ç”¨ARä½†æ˜¯éæ—¥æœŸç±»å‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># æ—¥æœŸçš„å­˜å‚¨é‡‡ç”¨äº† UTCï¼Œå¹¶ä¸”å­—æ®µä¸æ”¯æŒæ—¶åŒºï¼Œä½†æ˜¯æ‹¼å†™ SQL æ—¶ï¼Œä»¥ä¸œå…«æ—¶åŒºå»åšæŸ¥è¯¢</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span> <span class="s2">&quot;SELECT * FROM users WHERE created_at &gt;= &#39;2014-05-18 08:00:00&#39;&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># bad</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;users.created_at &gt;= ?&quot;</span><span class="p">,</span> <span class="s1">&#39;2014-05-18 00:00:00&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># good</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;users.created_at &gt;= ?&quot;</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;2014-05-18 00:00:00&#39;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ”¯æŒæ—¶åŒº</h2>

<p>å¦‚æœæ•°æ®åº“çš„å­—æ®µæ”¯æŒå¸¦æ•°æ®ï¼Œé‚£ä¹ˆåœ¨å»ºç«‹çš„æ—¶å€™ï¼Œå»ºè®®éƒ½å¸¦ä¸Šæ—¶åŒºã€‚ è™½ç„¶ä¼šå¸¦ä¸Šæ€§èƒ½ä¸Šçš„æ¶ˆè€—ï¼Œä½†æ˜¯åœ¨æ•°æ®åº“å¤„ç†è¿™ä¸ªå±‚é¢ä¸Šå¤„ç†ä¿è¯ä¸å‡ºé”™ã€‚</p>

<p>è¿™æ ·å°±ç®€å•äº†ï¼Œå¦‚æœé¡¹ç›®çš„ä½¿ç”¨äººç¾¤æ—¶è·¨æ—¶åŒºçš„ï¼Œé‚£ä¹ˆåœ¨æ—¥æœŸçš„å¤„ç†å’Œå­˜å‚¨ä¸Šéƒ½é€‰ç”¨UTCï¼Œåœ¨æ˜¾ç¤ºæ—¶ä½¿ç”¨æœ¬åœ°çš„æ—¶åŒºå»æ˜¾ç¤ºï¼›å¦‚æœé¡¹ç›®çš„ä½¿ç”¨äººç¾¤ä¸è·¨æ—¶åŒºï¼Œé‚£ä¹ˆé€‰ç”¨UTCå’Œæœ¬åœ°æ—¶åŒºéƒ½å¯ä»¥ï¼ˆå»ºè®®ä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼‰ã€‚</p>

<h2>åŒæ•°æ®åº“</h2>

<p>é¡¹ç›®æœ‰æ—¶å€™ä¼šé‡åˆ°è¦ä½¿ç”¨åŒæ•°æ®åº“çš„æƒ…å†µï¼Œå¦‚æ•°æ®å¹³å°ï¼Œé€šå¸¸æœ¬èº«æœ‰ä¼šæœ‰æ•°æ®åº“ï¼Œè€Œå…ƒæ•°æ®åˆ™æ¥è‡ªä¸šåŠ¡é¡¹ç›®ã€‚
è¿™ç§æƒ…å†µä¸‹ï¼Œå»ºè®®é‡‡ç”¨åŒä¸€ç§æ•°æ®åº“ï¼Œå³å¦‚æœä¸šåŠ¡é¡¹ç›®é‡Œä½¿ç”¨çš„æ˜¯ MySQL é‚£ä¹ˆå°±éƒ½ç”¨ MySQLï¼Œ å¯¹äºæ—¶åŒºçš„é€‰æ‹©ä¸Šä¹Ÿä½¿ç”¨åŒä¸€ç§æ—¶åŒºæ–¹æ¡ˆã€‚è¿™æ ·å¼€å‘äººå‘˜å°±ä¸éœ€è¦æ€»æ˜¯åˆ‡æ¢æ€ç»´æ–¹å¼ï¼Œèƒ½å¤Ÿé¿å…è®¸å¤šé”™è¯¯ã€‚å¦‚æœå·²æœ‰çš„é¡¹ç›®é€‰æ‹©çš„æ˜¯ä¸åŒçš„æ•°æ®åº“å¹¶ä¸”è¿˜å°†ç»§ç»­å¼€å‘ç»´æŠ¤ç›¸å½“é•¿ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆå»ºè®®å°½æ—©è¿ç§»æˆåŒæ ·çš„æ•°æ®åº“ï¼Œæ¯•ç«ŸåæœŸçš„ç»´æŠ¤æˆæœ¬è¦é«˜äºè¿ç§»çš„æˆæœ¬ã€‚</p>

<h2>æ€»ç»“</h2>

<p>æ€»çš„æ¥è¯´ï¼Œå¯¹äºæ—¥æœŸçš„å­˜å‚¨å’Œå¤„ç†ä¸Šå–å†³äºé¡¹ç›®çš„ä½¿ç”¨äººç¾¤ä»¥åŠå¼€å‘è®¾è®¡äººå‘˜æ‰€é€‰æ‹©çš„æ•°æ®åº“ï¼Œå¦‚æœé€‰æ‹©çš„æ•°æ®åº“æ”¯æŒæ—¶åŒºï¼Œé‚£ä¹ˆå»ºè®®åˆ›å»ºè¡¨æ—¶ç›¸åº”çš„å­—æ®µéƒ½å¸¦ä¸Šæ—¶åŒºï¼Œä»¥é¿å…æ—¥å¸¸çš„å¼€å‘ç»´æŠ¤ä¸­ç”±äºäººå‘˜å¯èƒ½å¼•èµ·çš„é”™è¯¯ã€‚è€Œå¯¹äºå¤šæ•°æ®åº“ï¼Œå»ºè®®å°½é‡é‡‡ç”¨åŒç§æ•°æ®åº“ï¼Œé™¤éä½ å–œæ¬¢æŠ˜è…¾å¹¶ä¸”è¿˜èƒ½ä¿è¯ä¸å‡ºé”™ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/27/working-with-timezone-in-rails-02/">Working With Timezone in Rails(02)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-27T20:30:00+08:00'><span class='date'>2014-04-27 20:30:00</span> <span class='time'>8:30 pm</span></time>
        
           | <a href="/blog/2014/04/27/working-with-timezone-in-rails-02/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/04/27/working-with-timezone-in-rails-02/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>åœ¨ <a href="/blog/2014/04/27/working-with-timezone-in-rails-01">ä¸Šä¸€ç¯‡</a> é‡Œï¼Œ
æˆ‘ä»¬è®²äº† MySQL å’Œ PostgreSQL åœ¨æ—¶åŒºå¤„ç†ä¸Šçš„åŒºåˆ«ï¼Œè¿™ä¸€ç¯‡é‡Œï¼Œæˆ‘ä»¬ä¸»è¦è®² Rails é‡Œæ—¶åŒºçš„å¤„ç†ã€‚</p>

<h2>æ—¥æœŸåœ°å­˜å‚¨ã€å¤„ç†ã€æ˜¾ç¤º</h2>

<p>å¯¹äºä¸€ä¸ªå¸¦æ•°æ®åº“çš„åº”ç”¨æ¥è¯´ï¼Œä½ å¿…é¡»è¦å»å…³æ³¨çš„å‡ ä¸ªé—®é¢˜ï¼šæ—¥æœŸçš„å­˜å‚¨ã€æ—¥æœŸçš„å¤„ç†ã€æ—¥æœŸçš„æ˜¾ç¤ºã€‚</p>

<ul>
<li>æ—¥æœŸçš„å­˜å‚¨ï¼Œå³ä¸€ä¸ªæ—¥æœŸå­˜å…¥æ•°æ®åº“æ—¶ï¼Œä½ è¦é‡‡ç”¨çš„æ˜¯ä½•ç§æ—¶åŒºå»å­˜å‚¨ï¼›</li>
<li>æ—¥æœŸçš„å¤„ç†ï¼Œå³ä»æ•°æ®åº“æ‹¿åˆ°çš„æ—¥æœŸæ•°æ®ï¼Œä½ è¦èƒ½æŠŠå®ƒæ­£ç¡®åœ°è§£æå‡ºæ¥ï¼›</li>
<li>æ—¥æœŸçš„æ˜¾ç¤ºï¼Œå³æ‹¿åˆ°æ­£ç¡®çš„æ—¥æœŸåï¼Œä½ è¦ä»¥ä½•ç§æ—¶åŒºå»ä½¿ç”¨å’Œæ˜¾ç¤ºã€‚</li>
</ul>


<p>ä¾‹å¦‚ï¼š<br>
ç°åœ¨æˆ‘ä»¬æ‰‹é‡Œæœ‰ä¸€ä¸ªæœ¬åœ°çš„æ—¶é—´ <code>2014-04-27 08:00:00 +08:00</code>ï¼Œ
å½“ä½ ä»¥ UTC æ ¼å¼ <code>2014-04-27 00:00:00 +00:00</code> å­˜å…¥æ•°æ®åº“ï¼Œ
ç›¸åº”åœ°ï¼Œ<br>
åœ¨ä¸œå…«åŒºï¼Œä½ è¦èƒ½æ˜¾ç¤ºæˆï¼š<code>2014-04-27 08:00:00 +08:00</code> <br>
åœ¨ä¸œä¸ƒåŒºï¼Œä½ è¦èƒ½æ˜¾ç¤ºæˆï¼š<code>2014-04-27 07:00:00 +07:00</code></p>

<h2>Rails æ—¶åŒºé…ç½®</h2>

<p>åœ¨ Rails é‡Œï¼Œæ—¶åŒºçš„è®¾ç½®æœ‰ä¸‹é¢ä¸¤ä¸ªé€‰é¡¹ï¼Œé»˜è®¤å€¼éƒ½æ˜¯ <code>:utc</code>ï¼Œ
å¯ä»¥åˆ° <a href="http://guides.rubyonrails.org/configuring.html">Rails Guide</a>  æŸ¥çœ‹ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.active_record.default_timezone = :utc
</span><span class='line'>config.time_zone = :utc</span></code></pre></td></tr></table></div></figure>


<h2>config.active_record.default_timezone</h2>

<p>è¿™ä¸ªè®¾ç½®æ˜¯æŒ‡æ˜å½“ä¸æ•°æ®åº“äº¤äº’æ—¶ä½¿ç”¨çš„æ—¶åŒºï¼Œå³å‰ä¸€ç¯‡æåˆ°çš„ <code>å½“å‰sessionçš„æ—¶åŒº</code>ï¼Œ
å®ƒåªæ”¯æŒ <code>:local</code> å’Œ <code>:utc</code> ä¸¤ä¸ªé€‰é¡¹ã€‚</p>

<p>æˆ‘æ›¾ç»ç–‘æƒ‘ä¸ºä»€ä¹ˆåªæ”¯æŒè¿™ä¸¤ç§ï¼Œåæ¥å‘ç°é“ç†å…¶å®å¾ˆç®€å•ã€‚</p>

<p>å¦‚æœåº”ç”¨çš„ä½¿ç”¨äººç¾¤æœ‰è·¨æ—¶åŒºçš„è¯ï¼Œé‚£ä¹ˆå­˜å‚¨å’Œå¤„ç†éƒ½åº”è¯¥ä½¿ç”¨ UTCï¼Œæ˜¾ç¤ºçš„æ—¶å€™å†æ ¹æ®å½“åœ°çš„æ—¶åŒºå»æ˜¾ç¤ºï¼›<br>
å¦‚æœåº”ç”¨çš„ä½¿ç”¨äººç¾¤ä¸è·¨æ—¶åŒºçš„è¯ï¼Œé‚£ä¹ˆå­˜å‚¨å’Œå¤„ç†éƒ½å¯ä»¥éšä½ è‡ªå·±å®šï¼Œä¸€èˆ¬éƒ½é€‰æ‹©å½“åœ°æ—¶åŒºæˆ–è€…UTCï¼Œæ€»ä¸ä¼šè¯´åœ¨ä¸œå…«åŒºï¼Œç„¶åä½ ç¡¬è¦ç”¨ä¸œä¸ƒåŒºçš„æ—¶åŒºå­˜ï¼Œé‚£ä¹ˆè¿™åœ¨å¤„ç†çš„æ—¶å€™å¾—å¤šè›‹ç–¼ï¼Œç¨å¾®ä¸æ³¨æ„å°±é”™äº†ï¼Œè¿™ä¸æ˜¯ç»™è‡ªå·±æ‰¾ç½ªå—ä¹ˆã€‚</p>

<h2>config.time_zone</h2>

<p>è¿™ä¸ªè®¾ç½®æŒ‡æ˜ï¼Œåœ¨ Ruby ä»£ç é‡Œï¼Œå¤„ç†å’Œä½¿ç”¨æ—¶æ‰€ç”¨çš„æ—¶åŒºï¼Œå¤©æœçš„ç å†œä¸€èˆ¬éƒ½æ˜¯é…ç½®æˆ <code>'Beijing'</code>ã€‚
<code>'Beijing'</code> è¿™ä¸ªå€¼ï¼Œå…¶å®æ˜¯è¢«æ˜ å°„æˆä¸ºäº† <code>Asia/Shanghai</code> è¿™ä¸ªå€¼ï¼Œ
å¯ä»¥ä» <a href="http://api.rubyonrails.org/classes/ActiveSupport/TimeZone.html">è¿™é‡Œ</a> çœ‹åˆ°ã€‚</p>

<h2>ä¾‹å­</h2>

<p>æœ¬ä¾‹å­åŸºäºï¼šæ•°æ®åº“çš„æ—¶åŒºéƒ½è®¾ç½®ä¸º <code>'+08:00'</code>ï¼Œå¹¶ä¸”å¦‚æœæ—¶ PGï¼Œå­˜å‚¨çš„å­—æ®µä¹Ÿä¸å¸¦æ—¶åŒºã€‚</p>

<p>å¦‚æœæ•°æ®åº“é‡Œå­˜çš„æ˜¯: <code>2014-04-27 00:00:00</code>ï¼Œåˆ™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Example 1</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">default_timezone</span> <span class="o">=</span> <span class="ss">:utc</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">time_zone</span> <span class="o">=</span> <span class="s1">&#39;Beijing&#39;</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># And then in console</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">created_at</span> <span class="c1"># =&gt; 2014-04-27 08:00:00 +08:00</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Example 2</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">default_timezone</span> <span class="o">=</span> <span class="ss">:local</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">time_zone</span> <span class="o">=</span> <span class="s1">&#39;Beijing&#39;</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># And then in console</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">created_at</span> <span class="c1"># =&gt; 2014-04-27 00:00:00 +08:00</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢æåˆ°äº†å¦‚æœæ•°æ®åº“æ˜¯PGï¼Œé‚£ä¹ˆå­—æ®µä¹Ÿä¸å¸¦æ—¶åŒºã€‚è¿™ä¹ˆè¯´æ˜¯å› ä¸ºï¼Œå¦‚æœå­—æ®µå¸¦äº†æ—¶åŒºï¼Œå³ <code>timestamp with time zone</code>ï¼Œé‚£ä¹ˆæ— è®ºä½ å½“å‰ session æ—¶åŒºæ˜¯ä»€ä¹ˆï¼Œä¼ è¿‡æ¥çš„æ—¶é—´å­—ç¬¦æœ‰æ²¡æœ‰å¸¦æ—¶åŒºï¼ŒPGéƒ½ä¼šè‡ªåŠ¨å¸®ä½ åšç›¸åº”çš„è½¬æ¢ï¼Œç»“æœå°±ä¸å†æ˜¯ä¸Šé¢çš„ç»“æœäº†ï¼Œè€Œæ˜¯ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config.active_record.default_timezone æ— è®ºæ˜¯ :local è¿˜æ˜¯ :utc</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">time_zone</span> <span class="o">=</span> <span class="s1">&#39;Beijing&#39;</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># And then in console</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">created_at</span> <span class="c1"># =&gt; 2014-04-27 08:00:00 +08:00</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ€»ç»“</h2>

<ol>
<li>å¯¹äºä¸€ä¸ªå¸¦æ•°æ®å­˜å‚¨çš„åº”ç”¨æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦å»è€ƒè™‘æ—¥æœŸç±»æ•°æ®çš„å­˜å‚¨ã€å¤„ç†å’Œæ˜¾ç¤º</li>
<li>åœ¨ Rails ä¸­ï¼Œä½ éœ€è¦äº†è§£æ—¶åŒºçš„è®¾ç½®å¹¶æ ¹æ®ä½ çš„éœ€è¦é…ç½®å¥½ä¸Šé¢è¯´çš„ä¸¤ä¸ªé€‰é¡¹</li>
<li>å¯¹äºæœ¬åœ°æ—¶é—´çš„æ˜¾ç¤ºï¼Œ37singals æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œ <a href="https://github.com/basecamp/local_time">æŸ¥çœ‹è¿™é‡Œ</a></li>
</ol>


<p>è€Œå¯¹äºåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ•°æ®åº“çš„æ—¶åŒºè®¾ç½®åº”è¯¥å¦‚ä½•å»é€‰æ‹©ï¼Œ
è€Œç›¸åº”çš„åœ¨ Rails é‡Œè¿™ä¸¤ä¸ªé€‰é¡¹åº”è¯¥å¦‚ä½•è®¾ç½®
ä»¥åŠä¸€äº›éœ€è¦æ³¨æ„çš„é—®é¢˜ï¼Œå°†åœ¨<a href="/blog/2014/05/18/working-with-timezone-in-rails-03">ä¸‹ä¸€ç¯‡</a>ä¸­é˜è¿°ã€‚</p>

<p><br /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/27/working-with-timezone-in-rails-01/">Working With Timezone in Rails(01)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-27T19:05:00+08:00'><span class='date'>2014-04-27 19:05:00</span> <span class='time'>7:05 pm</span></time>
        
           | <a href="/blog/2014/04/27/working-with-timezone-in-rails-01/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/04/27/working-with-timezone-in-rails-01/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>åœ¨è®² Rails é‡Œå¯¹æ—¶åŒºçš„å¤„ç†å‰ï¼Œå¾—å…ˆæ¥çœ‹çœ‹æ•°æ®åº“å¯¹æ—¶åŒºçš„å¤„ç†åˆ°åº•æ—¶æ€æ ·çš„ã€‚</p>

<p>åœ¨å¯¹æ—¶åŒºçš„å¤„ç†ä¸Šï¼ŒMySQL(v5.5) ä¸ PostgreSQL(v9.3) æ˜¯æœ‰ä¸€äº›ä¸åŒçš„ã€‚</p>

<h2>MySQL</h2>

<p>é€šè¿‡è‡ªå·±çš„å‡ æ¬¡éªŒè¯ï¼Œæˆ‘å¾—åˆ°äº†ä¸‹é¢çš„ç»“è®ºï¼š</p>

<ol>
<li>MySQL çš„æ—¶åŒºé»˜è®¤è·Ÿç³»ç»Ÿæ—¶åŒºæ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡ <code>SELECT @@global.time_zone, @@session.time_zone;</code> å¯ä»¥æŸ¥çœ‹MySQLçš„æ—¶åŒºå’Œå½“å‰å¯¹è¯çš„æ—¶åŒº</li>
<li>å½“å‰ session æ—¶åŒºä¼šå½±å“åˆ° <code>now()</code> è¿™ä¸€ç±»å†…ç½®å‡½æ•°çš„ç»“æœ</li>
<li>æ’å…¥æˆ–æ›´æ–°æ•°æ®æ—¶ï¼ŒMySQL å¹¶ä¸ä¼šå»å¤„ç†æ’å…¥çš„å€¼æ˜¯å¦æœ‰å¸¦æ—¶åŒº</li>
</ol>


<p>å¯ä»¥æ¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>

<p>æŸ¥çœ‹æ—¶åŒºå’Œ <code>select now()</code> çš„ç»“æœ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; SELECT @@global.time_zone, @@session.time_zone;
</span><span class='line'>+--------------------+---------------------+
</span><span class='line'>| @@global.time_zone | @@session.time_zone |
</span><span class='line'>+--------------------+---------------------+
</span><span class='line'>| SYSTEM             | SYSTEM              |
</span><span class='line'>+--------------------+---------------------+
</span><span class='line'>1 row in set (0.00 sec)
</span><span class='line'>mysql&gt; select now();
</span><span class='line'>+---------------------+
</span><span class='line'>| now()               |
</span><span class='line'>+---------------------+
</span><span class='line'>| 2014-04-27 19:19:11 |
</span><span class='line'>+---------------------+
</span><span class='line'>1 row in set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<p>è®¾ç½®å½“å‰ session çš„æ—¶åŒºï¼Œå¹¶é€šè¿‡ <code>select now();</code> æ¥æŸ¥çœ‹ç»“æœï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; set time_zone = '+08:00';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; select now();
</span><span class='line'>+---------------------+
</span><span class='line'>| now()               |
</span><span class='line'>+---------------------+
</span><span class='line'>| 2014-04-27 19:19:59 |
</span><span class='line'>+---------------------+
</span><span class='line'>1 row in set (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; set time_zone = '+00:00';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; select now();
</span><span class='line'>+---------------------+
</span><span class='line'>| now()               |
</span><span class='line'>+---------------------+
</span><span class='line'>| 2014-04-27 11:20:10 |
</span><span class='line'>+---------------------+
</span><span class='line'>1 row in set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<p>è®¾ç½®å½“å‰ session çš„æ—¶åŒºä¸º &lsquo;+08:00'ï¼ˆå³ä¸œå…«åŒºï¼‰ï¼Œä½†æ˜¯æ’å…¥æ•°æ®æ—¶ï¼Œæˆ‘ä»¬ç”¨ UTC æ—¶åŒºçš„å€¼ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç»“æœï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; describe users;
</span><span class='line'>+------------+--------------+------+-----+---------+-------+
</span><span class='line'>| Field      | Type         | Null | Key | Default | Extra |
</span><span class='line'>+------------+--------------+------+-----+---------+-------+
</span><span class='line'>| name       | varchar(255) | YES  |     | NULL    |       |
</span><span class='line'>| created_at | datetime     | YES  |     | NULL    |       |
</span><span class='line'>+------------+--------------+------+-----+---------+-------+
</span><span class='line'>2 rows in set (0.03 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; insert into users (name, created_at) values ('å¼ ä¸‰', '1990-01-01 00:00:00 +0000');
</span><span class='line'>Query OK, 1 row affected, 1 warning (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; insert into users (name, created_at) values ('æå››', '1990-01-01 00:00:00 +0800');
</span><span class='line'>Query OK, 1 row affected, 1 warning (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; insert into users (name, created_at) values ('æå››', '1990-01-01 00:00:00 +8:00');
</span><span class='line'>Query OK, 1 row affected, 1 warning (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; insert into users (name, created_at) values ('æå››', '1990-01-01 00:00:00 +08:00');
</span><span class='line'>Query OK, 1 row affected, 1 warning (0.04 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; insert into users (name, created_at) values ('æå››', '1990-01-01 00:00:00');
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; select * from users;
</span><span class='line'>+--------+---------------------+
</span><span class='line'>| name   | created_at          |
</span><span class='line'>+--------+---------------------+
</span><span class='line'>| å¼ ä¸‰   | 1990-01-01 00:00:00 |
</span><span class='line'>| æå››   | 1990-01-01 00:00:00 |
</span><span class='line'>| æå››   | 1990-01-01 00:00:00 |
</span><span class='line'>| æå››   | 1990-01-01 00:00:00 |
</span><span class='line'>| æå››   | 1990-01-01 00:00:00 |
</span><span class='line'>+--------+---------------------+
</span><span class='line'>5 rows in set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<p>é€šè¿‡ä¸Šé¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªè¦ä½ å¸¦äº†æ—¶åŒºï¼ŒMySQL å°±ä¼šç»™ä½ ä¸ªè­¦å‘Šï¼Œç„¶åå°±ä¸ç®¡äº†ï¼Œæˆªå–å‰é¢æ—¶é—´ç›´æ¥å°±å­˜è¿›å»äº†ã€‚</p>

<h2>PostgreSQL</h2>

<p>åŒæ ·çš„ï¼Œåœ¨ PG ä¸­ï¼Œåšäº†ä¸€ç»„æµ‹è¯•ä¹‹åï¼Œæˆ‘å¾—å‡ºçš„ç»“è®ºï¼š</p>

<ol>
<li>é»˜è®¤æ—¶åŒºä¸º GMTï¼Œå…·ä½“å¯å‚è€ƒ <a href="http://www.baike.com/wiki/GMT">here</a></li>
<li>å½“å‰ session çš„è®¾ç½®ä¼šå½±å“åˆ°å†…ç½®çš„ä¸€äº›å‡½æ•°ï¼Œå¦‚ï¼šnow()</li>
<li>æ’å…¥æˆ–æ›´æ–°æ•°æ®ï¼Œå¦‚æœæ›´æ”¹çš„å­—æ®µæ˜¯å¸¦æœ‰æ—¶åŒºçš„ï¼Œé‚£ä¹ˆ PG æ˜¯ä¼šå¯¹å…¶è¿›è¡Œè½¬æ¢çš„</li>
</ol>


<p>ä¸‹é¢æ¥çœ‹çœ‹ä¸€äº›éªŒè¯çš„ä¾‹å­ï¼š</p>

<p>ä¸è®¾ç½®æ—¶åŒºï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤ä¸º GMTï¼Œæ—¶é—´å¯ä»¥è®¤ä¸ºè·Ÿæ—¶é—´æ ‡å‡†æ—¶é—´(UTC)ä¸€è‡´</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>test=# show timezone;
</span><span class='line'> TimeZone
</span><span class='line'>----------
</span><span class='line'> GMT
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>test=# select now();
</span><span class='line'>              now
</span><span class='line'>-------------------------------
</span><span class='line'> 2014-04-27 11:57:14.541743+00
</span><span class='line'>(1 row)</span></code></pre></td></tr></table></div></figure>


<p>ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬å°†æ—¶åŒºè®¾ç½®ä¸º &lsquo;PRC'ï¼ˆå³ä¸œå…«åŒºï¼Œä¸­åäººæ°‘å…±å’Œå›½ï¼‰ æ¥éªŒè¯</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>test=# show timezone;
</span><span class='line'> TimeZone
</span><span class='line'>----------
</span><span class='line'> PRC
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>test=# select now();
</span><span class='line'>              now
</span><span class='line'>-------------------------------
</span><span class='line'> 2014-04-27 19:59:47.312923+08
</span><span class='line'>(1 row)</span></code></pre></td></tr></table></div></figure>


<p>å»ºç«‹ä¸€å¼ è¡¨ï¼Œå…¶ä¸­ä¸€ä¸ªå­—æ®µå¸¦æœ‰æ—¶åŒºï¼Œä¸€ä¸ªåˆ™æ²¡æœ‰</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>test=# \d users;
</span><span class='line'>                 Table "public.users"
</span><span class='line'>   Column   |            Type             | Modifiers
</span><span class='line'>------------+-----------------------------+-----------
</span><span class='line'> name       | character varying(255)      |
</span><span class='line'> created_at | timestamp with time zone    |
</span><span class='line'> updated_at | timestamp without time zone |</span></code></pre></td></tr></table></div></figure>


<p>åˆ†åˆ«æ’å…¥ä¸å¸¦æ—¶åŒºã€å¸¦ä¸åŒæ—¶åŒºçš„å‡ ç»„å€¼ï¼Œç„¶åæŸ¥çœ‹ç»“æœ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>test=# insert into users values ('å¼ ä¸‰', '2014-04-27 08:00:00', '2014-04-27 08:00:00');
</span><span class='line'>INSERT 0 1
</span><span class='line'>test=# insert into users values ('å¼ ä¸‰', '2014-04-27 08:00:00 +00:00', '2014-04-27 08:00:00 +00:00');
</span><span class='line'>INSERT 0 1
</span><span class='line'>test=# insert into users values ('å¼ ä¸‰', '2014-04-27 08:00:00 +08:00', '2014-04-27 08:00:00 +08:00');
</span><span class='line'>INSERT 0 1
</span><span class='line'>test=# insert into users values ('å¼ ä¸‰', '2014-04-27 08:00:00 +09:00', '2014-04-27 08:00:00 +09:00');
</span><span class='line'>INSERT 0 1
</span><span class='line'>test=# select * from users;
</span><span class='line'> name |       created_at       |     updated_at
</span><span class='line'>------+------------------------+---------------------
</span><span class='line'> å¼ ä¸‰ | 2014-04-27 08:00:00+08 | 2014-04-27 08:00:00
</span><span class='line'> å¼ ä¸‰ | 2014-04-27 16:00:00+08 | 2014-04-27 08:00:00
</span><span class='line'> å¼ ä¸‰ | 2014-04-27 08:00:00+08 | 2014-04-27 08:00:00
</span><span class='line'> å¼ ä¸‰ | 2014-04-27 07:00:00+08 | 2014-04-27 08:00:00
</span><span class='line'>(4 rows)</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬æ”¹å˜ä¸€ä¸‹å½“å‰ session çš„æ—¶åŒºï¼Œå¹¶æŸ¥çœ‹åˆšæ’å…¥çš„å€¼ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>test=# set timezone = '+00:00';
</span><span class='line'>SET
</span><span class='line'>test=# select now();
</span><span class='line'>              now
</span><span class='line'>-------------------------------
</span><span class='line'> 2014-04-27 12:09:10.931947+00
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>test=# select * from users;
</span><span class='line'> name |       created_at       |     updated_at
</span><span class='line'>------+------------------------+---------------------
</span><span class='line'> å¼ ä¸‰ | 2014-04-27 00:00:00+00 | 2014-04-27 08:00:00
</span><span class='line'> å¼ ä¸‰ | 2014-04-27 08:00:00+00 | 2014-04-27 08:00:00
</span><span class='line'> å¼ ä¸‰ | 2014-04-27 00:00:00+00 | 2014-04-27 08:00:00
</span><span class='line'> å¼ ä¸‰ | 2014-04-26 23:00:00+00 | 2014-04-27 08:00:00
</span><span class='line'>(4 rows)</span></code></pre></td></tr></table></div></figure>


<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸å¸¦æ—¶åŒºå’Œå¸¦æ—¶åŒºçš„å­—æ®µç»“æœï¼š</p>

<p>ä¸å¸¦æ—¶åŒºçš„å­—æ®µï¼š</p>

<ol>
<li>æ— è®ºæ’å…¥çš„æ•°æ®å¸¦ä¸å¸¦æ—¶åŒºï¼Œåªæˆªå–å‰é¢çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸ä¼šå¯¹å€¼è¿›è¡Œå¤„ç†</li>
<li>å½“å‰ session çš„æ—¶åŒºï¼Œä¸ä¼šå½±å“æ’å…¥çš„å€¼</li>
</ol>


<p>å¸¦æ—¶åŒºçš„å­—æ®µï¼š</p>

<ol>
<li>è‹¥ä¸å¸¦æ—¶åŒºï¼Œåˆ™æ’å…¥çš„æ•°æ®ä¼šè¢«åŠ ä¸Šå½“å‰ session çš„æ—¶åŒº</li>
<li>è‹¥å¸¦æ—¶åŒºï¼Œåˆ™æŒ‰è¿™ä¸ªå€¼æŒ‡å®šæ—¶åŒºå­˜å…¥ï¼Œå–æ•°æ®æ—¶ï¼Œä¼šæ ¹æ®å½“å‰çš„ session æ—¶åŒºè¿›è¡Œç›¸åº”çš„è½¬æ¢</li>
</ol>


<h2>æ€»ç»“</h2>

<p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹çš„ä¸€äº›ç»“è®ºï¼š</p>

<p>MySQL å’Œ PostgreSQL åœ¨æ—¶åŒºå¤„ç†ä¸Šå…±åŒçš„åœ°æ–¹</p>

<ol>
<li>å½“å‰ session çš„æ—¶åŒºä¼šå½±å“åˆ°å†…ç½®çš„ä¸€äº›å‡½æ•°çš„å€¼ï¼Œå¦‚ï¼šnow() ç­‰</li>
<li>PG é‡Œä¸å¸¦æ—¶åŒºçš„å­—æ®µä¸ MySQL çš„å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„</li>
</ol>


<p>ä¸åŒçš„åœ°æ–¹</p>

<ol>
<li>MySQL å¹¶ä¸æ”¯æŒæœ‰æ—¶åŒºçš„å­—æ®µï¼Œè€Œ PG æ”¯æŒ</li>
<li>MySQL å¹¶ä¸ä¼šå»å¤„ç†æ’å…¥æˆ–æ›´æ–°çš„å€¼æ˜¯å¦å¸¦æœ‰æ—¶åŒºï¼Œè€Œ PG å¦‚æœæ—¶é‡åˆ°å¸¦æ—¶åŒºçš„å­—æ®µï¼Œåˆ™ä¼šè¿›è¡Œå¤„ç†</li>
</ol>


<p><br /></p>

<p><a href="/blog/2014/04/27/working-with-timezone-in-rails-02">ä¸‹ä¸€ç¯‡ï¼šWorking with timezone in Rails(02)</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/5">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/11/26/keep-attribute-safe-in-rails/">å­—æ®µåŠ å¯†å­˜å‚¨-Rails</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/19/rubocop/">Use Rubocop to Control Your Ruby Code's Quality</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/13/actioncable-sourcecode-frontend-part-3-monitor/">ActionCable æºç é˜…è¯»ç¬”è®°-å‰ç«¯éƒ¨åˆ†-3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/13/actioncable-sourcecode-frontend-part-2-connection/">ActionCable æºç é˜…è¯»ç¬”è®°-å‰ç«¯éƒ¨åˆ†-2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/13/actioncable-sourcecode-frontend-part-1-hello/">ActionCable æºç é˜…è¯»ç¬”è®°-å‰ç«¯éƒ¨åˆ†-1</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/justqyx">@justqyx</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'justqyx',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - é‚±æºé‘« -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yuanxin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
