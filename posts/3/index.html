
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JustQyx</title>
  <meta name="author" content="邱源鑫">

  
  <meta name="description" content="寻找的过程 今年一月份，我对于我自己的职业规划做了一个初步的想象，我阐述了自己未来想在哪一个城市，
做什么样的工作，过什么样的生活，需要我在什么样的阶段做好什么样的准备。
但这么一些想象离现实有些远或者说现阶段的我想了也只能是想了，无法有实际性东西的输出。 三月份的时候，我在 Evernote &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.justqyx.me/posts/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="JustQyx" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-65882934-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">JustQyx</a></h1>
  
    <h2>大道至简</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="hzuqiuyuanxin@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="www.justqyx.me">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/blog/blogs">Blogs</a></li>
  <li><a href="/blog/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/07/my-career-roadmap/">职业定位</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-07T10:51:22+08:00'><span class='date'>2015-06-07 10:51:22</span> <span class='time'>10:51 am</span></time>
        
           | <a href="/blog/2015/06/07/my-career-roadmap/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2015/06/07/my-career-roadmap/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>寻找的过程</h2>

<p>今年一月份，我对于我自己的职业规划做了一个初步的想象，我阐述了自己未来想在哪一个城市，
做什么样的工作，过什么样的生活，需要我在什么样的阶段做好什么样的准备。
但这么一些想象离现实有些远或者说现阶段的我想了也只能是想了，无法有实际性东西的输出。</p>

<p>三月份的时候，我在 Evernote 写了一篇《我的焦虑》，阐述了我在职业上、生活上所面对的疑惑，
而现在的状态，只能在工作上向前迈进，而生活方面则很难。</p>

<p>五月底的时候，又特意重新看了乔布斯在斯坦福大学的演讲，觉得对于现在的我有着重要的指导意义：
我必须去确定我喜欢什么。无论花多长时间，这都是值得去探索的话题。
我期望在某一天我也能够进入这样的一种状态：把每一天当成生命的最后一天来过。</p>

<p>这几天，翻开了之前 evernote 记录的一些零散的笔记，看到了「决定不做什么」。大意是建议人们，
在面对选择但又不是那么确定的时候,决定不做什么，比决定做什么更重要。
因为决定不做的那些一定是自己不想要的，而无法决定的那些，最起码自己不拒绝。
这也是跟师兄聊了之后对我几点建议之一。</p>

<h2>确定</h2>

<p>昨天，2015-06-06，一年一度高考正式开始的日子。</p>

<p>这几天，跟一些人聊职业、聊人生的话题，感触越来越多，感觉对于自己来讲也越来越清楚。
想起了之前同事推荐的一篇文章「程序员的四个象限和两条主线」，于是重新看了一遍。</p>

<p>这篇文章里，主要阐述的是程序员的职业规划问题，更深入一点来讲，阐述的是作者多年来，在接触各种各样的程序员后，
总结出的程序员的职业发展大致有几种：</p>

<ul>
<li>雇员，即普通的上班族</li>
<li>自由职业者和小企业主</li>
<li>以规模化为前提的企业主</li>
<li>投资人</li>
</ul>


<p>最后又总结为两条线：</p>

<ul>
<li>技术线</li>
<li>管理线</li>
</ul>


<p>我从这里面，找到了自己的位置。想想之前其实最大的困惑还是，不知道自己究竟有多少种选择，
于是日子充满着对现在的不安分，对未来的迷茫。</p>

<p>「全栈」二字，如今的我有着更为深刻的理解，不在仅仅是计算机领域的只是，还涉及到其他领域的知识。
而这也是我接下来三年，五年，甚至十年的目标，努力让自己成为一个 T 字形的人。
纵向方面，基础的有计算机基础知识、程序语言设计，进一步的有前后端框架、数据库、架构等等;
横向方面，关注产品和设计、经济和金融领域。同时学习观察技术潮流，关注投资市场和细分市场。
但随着时间的推移，自身知识面的扩展，这些可以被修正或者推倒。
今年的目标就是踏出第一步，把这些变成我生活的一部分。</p>

<p>上面阐述的这些并不是实际的、可以执行的计划，而是我接下来所有决定和努力的指导思想。
它将辅助我看清更多事物之间的联系，不再为新事物的出现而感到力不从心，不再为旧事物的淘汰而感到不安。</p>

<h2>任何事情都不是一触而就的</h2>

<p>这是两年工作下来最为深刻的体会。从上大学开始，就一直在想自己的人生将何去何从的问题，
毕业后这种思考更为强烈和频繁，今天的这些内容它只是我寻找答案的一个过程，绝不是最终的答案。
而对于过程，或许可以用我看到过的一句话来看待：</p>

<blockquote><p>人之所以不成功，或许不是因为缺乏足够的毅力，而是没有掌握科学的方法。</p></blockquote>

<p>如今的我在面对一个目标时，更加注重耐心和付出。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/31/inspect-simple-form-2/">Inspect SimpleForm (2)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-31T01:24:37+08:00'><span class='date'>2015-05-31 01:24:37</span> <span class='time'>1:24 am</span></time>
        
           | <a href="/blog/2015/05/31/inspect-simple-form-2/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2015/05/31/inspect-simple-form-2/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>上一篇阐述了 SimpleForm 的基本原理，以及阐述了 Wrapper 内部的一个基本的渲染过程，
这一篇，我将基于上文中的 :horizontal_form 这个 wrapper 例子来阐述清楚 Wrapper 的整个渲染过程。</p>

<h2>Wrapper 包含着对 Component 的一个管理。</h2>

<p>上一篇我们在 Rails Console 输出了下面这么一段内容，从这段内容我们可以看到，
我们的 Root 实例中有两个实例变量： @components 和 @defaults。</p>

<figure class='code'><figcaption><span> (simple_form.rb)</span> <a href='/downloads/code/20150531/simple_form.rb'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;SimpleForm::Wrappers::Root:0x007fedd7263b18</span>
</span><span class='line'> <span class="vi">@components</span><span class="o">=</span>
</span><span class='line'>  <span class="o">[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298660 @namespace=:html5, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd72985e8 @namespace=:placeholder, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298598 @namespace=:maxlength, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298520 @namespace=:pattern, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd72984d0 @namespace=:min_max, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298458 @namespace=:readonly, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd72983b8 @namespace=:label, @options={:class=&gt;&quot;col-sm-3 control-label&quot;}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Many:0x007fedd7263be0</span>
</span><span class='line'>    <span class="vi">@components</span><span class="o">=</span>
</span><span class='line'>     <span class="o">[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298188 @namespace=:input, @options={:class=&gt;&quot;form-control&quot;}&gt;,</span>
</span><span class='line'>      <span class="c1">#&lt;SimpleForm::Wrappers::Single:0x007fedd7263fa0</span>
</span><span class='line'>       <span class="vi">@component</span><span class="o">=</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263f78 @namespace=:error, @options={}&gt;,</span>
</span><span class='line'>       <span class="vi">@components</span><span class="o">=[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263f78 @namespace=:error, @options={}&gt;],</span>
</span><span class='line'>       <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;help-block&quot;</span><span class="o">]</span><span class="p">},</span>
</span><span class='line'>       <span class="vi">@namespace</span><span class="o">=</span><span class="ss">:error</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>      <span class="c1">#&lt;SimpleForm::Wrappers::Single:0x007fedd7263cf8</span>
</span><span class='line'>       <span class="vi">@component</span><span class="o">=</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263ca8 @namespace=:hint, @options={}&gt;,</span>
</span><span class='line'>       <span class="vi">@components</span><span class="o">=[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263ca8 @namespace=:hint, @options={}&gt;],</span>
</span><span class='line'>       <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;help-block&quot;</span><span class="o">]</span><span class="p">},</span>
</span><span class='line'>       <span class="vi">@namespace</span><span class="o">=</span><span class="ss">:hint</span><span class="o">&gt;]</span><span class="p">,</span>
</span><span class='line'>    <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;col-sm-9&quot;</span><span class="o">]</span><span class="p">},</span>
</span><span class='line'>    <span class="vi">@namespace</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;]</span><span class="p">,</span>
</span><span class='line'> <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;form-group&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:error_class</span><span class="o">=&gt;</span><span class="s2">&quot;has-error&quot;</span><span class="p">,</span> <span class="ss">:maxlength</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:pattern</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:min_max</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:readonly</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">},</span>
</span><span class='line'> <span class="vi">@namespace</span><span class="o">=</span><span class="ss">:wrapper</span><span class="p">,</span>
</span><span class='line'> <span class="vi">@options</span><span class="o">=</span><span class="p">{</span><span class="ss">:maxlength</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:pattern</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:min_max</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:readonly</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">}</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>@components 包含了一些 Leaf、Single、Many，这些东西将决定着最后的输出内容，例如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;col-sm-3&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-sm-9&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;email&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>而 @defaults 一看就知道，它是整个表单控件最外层的包裹。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="c">&lt;!--- ...... --&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们上篇就已经提到了 Wrapper 内部是如何渲染的，即递归地调用 component.render 得到每个 component 的输出内容，
然后拼接起来，最后用 wrap 完成最后的包裹后输出。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/simple_form/wrappers/many.rb</span>
</span><span class='line'><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">html_safe</span>
</span><span class='line'>  <span class="n">options</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">options</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">components</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">component</span><span class="o">|</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="n">component</span><span class="o">.</span><span class="n">namespace</span><span class="o">]</span> <span class="o">==</span> <span class="kp">false</span>
</span><span class='line'>    <span class="n">rendered</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">content</span><span class="o">.</span><span class="n">safe_concat</span> <span class="n">rendered</span><span class="o">.</span><span class="n">to_s</span> <span class="k">if</span> <span class="n">rendered</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">wrap</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在让我们来详细看一看两件事情</p>

<ol>
<li>input 是什么</li>
<li>component.render(input) 的执行过程</li>
</ol>


<h2>Input</h2>

<p>前面我们也提到过 f.input 这一段代码，请阅读 <code>lib/simple_form/form_builder.rb</code> 这个文件里的代码，
通过阅读，循着 find_input -> find_mapping 这两个方法，最终它是根据 attribute 的类型来找到对应的
类并实例化，例如是 String 类型，就返回一个 StringInput 类的实例，其他的如 Boolean、Numeric、File 都是如此。
我们从源码文件目录里的 <code>lib/simple_form/inputs</code> 也可以看到一系列的 Input，而这些 Input 全部都继承与 Base 这个类。</p>

<p>但是先到此为此，我们现在只需要了解 input 是什么，至于内部还有什么东西，我们需要在了解 component.render(input)
之后再来看会更好，顺着渲染的流程走更容易理解。</p>

<h2>component.render(input)</h2>

<p>同样的，在上文中的 <code>lib/simple_form/form_builder.rb</code> 这个文件里我们继续寻找 component 是什么，
继续阅读，循着 find_wrapper -> find_wrapper_mapping 这两个方法，最终我们可以发现，它根据 input.input_type
来找到合适 wrapper，即 SimpleForm.wrapper_mappings[input_type]，而 SimpleForm.wrapper_mappings 是我们在
项目里所配置的。即 <code>config/initializers/simple_form_bootstrap3.rb</code> 里的这么一段代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SimpleForm</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">wrapper_mappings</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">check_boxes</span><span class="p">:</span> <span class="ss">:vertical_radio_and_checkboxes</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">radio_buttons</span><span class="p">:</span> <span class="ss">:vertical_radio_and_checkboxes</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">file</span><span class="p">:</span> <span class="ss">:vertical_file_input</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">boolean</span><span class="p">:</span> <span class="ss">:vertical_boolean</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">datetime</span><span class="p">:</span> <span class="ss">:multi_select</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">date</span><span class="p">:</span> <span class="ss">:multi_select</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">time</span><span class="p">:</span> <span class="ss">:multi_select</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>因此，它所找到的就是我们一开始所配置的 wrapper，他们全部保存在 SimpleForm.wrappers 这个类变量里。
现在让我们来看一看三个例子。</p>

<h2>SimpleForm::Inputs::Base</h2>

<p>在进入例子之前，有必要阐述 SimpleForm::Inputs::Base 这个类，它是所有 SimpleForm 抽象出来的表单控件的一个基类。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">SimpleForm</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Inputs</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Base</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">ERB</span><span class="o">::</span><span class="no">Util</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">TranslationHelper</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">extend</span> <span class="no">I18nCache</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">Autofocus</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">Disabled</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">Readonly</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">Required</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">Validators</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">Errors</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">Hints</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">HTML5</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">LabelInput</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">Maxlength</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">MinMax</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">Pattern</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">Placeholders</span>
</span><span class='line'>      <span class="kp">include</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Components</span><span class="o">::</span><span class="no">Readonly</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面的代码我们可以看到，其 include 了许多 Components，这些 Components 其实是为 SimpleForm::Inputs::StringInput、
SimpleForm::Inputs::FileInput 这些真正的表单控件注入一些方法，这些方法可能是用来改变 Input 实例的一些配置，
也可能是生成一段 HTML 文本，下面的例子会阐述这么一点。</p>

<h2>b.use :input</h2>

<p>从之前的讲解我们知道 <code>b.use :input</code> 将会生成一个 SimpleForm::Wrappers::Root 实例，
然后其 @compoennts 就会存储着与此相关的 SimpleForm::Wrappers::Leaf 实例。</p>

<p>假如我们这里的 input 是一个 SimpleForm::Inputs::StringInput 的一个实例，而 component 就是
SimpleForm::Wrappers::Leaf 的一个实例，那么我们来看看 component.render 里的这个方法定义：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/simple_form/wrappers/leaf.rb</span>
</span><span class='line'><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># 我们先前在 Rails Console 中打出来的文本里有这么一段</span>
</span><span class='line'>  <span class="c1"># &lt;SimpleForm::Wrappers::Leaf:0x007fedd7298188 @namespace=:input, @options={:class=&gt;&quot;form-control&quot;}&gt;</span>
</span><span class='line'>  <span class="c1"># 所以这里的 @namespace 的值为 :input</span>
</span><span class='line'>  <span class="nb">method</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="vi">@namespace</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nb">method</span><span class="o">.</span><span class="n">arity</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="no">SimpleForm</span><span class="o">::</span><span class="no">CUSTOM_INPUT_DEPRECATION_WARN</span> <span class="o">%</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@namespace</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">method</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">method</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="vi">@options</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以看到，这个 render 方法其实是让 input 这个 StringInput 实例去调用自己的 input 方法，
找到 StringInput 的 input 方法定义：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/simple_form/inputs/strin_input.rb</span>
</span><span class='line'><span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="n">wrapper_options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">string?</span>
</span><span class='line'>    <span class="n">input_html_classes</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">input_html_options</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">||=</span> <span class="n">input_type</span> <span class="k">if</span> <span class="n">html5?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">merged_input_options</span> <span class="o">=</span> <span class="n">merge_wrapper_options</span><span class="p">(</span><span class="n">input_html_options</span><span class="p">,</span> <span class="n">wrapper_options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@builder</span><span class="o">.</span><span class="n">text_field</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">,</span> <span class="n">merged_input_options</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以我们可以看到，最后的输出内容其实是使用 @builder (SimpleForm::FormBuilder 的一个实例) 的 text_field 方法
来生成一个类似这样的 <code>&lt;input type="text" name='resource[attribute_name]' /&gt;</code> 一段文本。</p>

<h2>b.use :label</h2>

<p>同理， Label 标签的生成也是类似。 SimpleForm::Component::Label 的里 label 方法定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="n">wrapper_options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="n">label_options</span> <span class="o">=</span> <span class="n">merge_wrapper_options</span><span class="p">(</span><span class="n">label_html_options</span><span class="p">,</span> <span class="n">wrapper_options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">generate_label_for_attribute?</span>
</span><span class='line'>      <span class="vi">@builder</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">label_target</span><span class="p">,</span> <span class="n">label_text</span><span class="p">,</span> <span class="n">label_options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">template</span><span class="o">.</span><span class="n">label_tag</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="n">label_text</span><span class="p">,</span> <span class="n">label_options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>也是让 @builder 调用 label 来生成类似这样的 <code>&lt;label class="col-sm-3"&gt;Email&lt;/label&gt;</code> 一段文本。</p>

<h2>b.use :placeholder</h2>

<p>placeholder，html5，readonly 这一类的 Component，并没有实际的 HTML 文本输出，而是修改 input 这种表单控件的
一些配置，我们来看看 placholder 的代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/simple_form/components/placeholders.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">SimpleForm</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Components</span>
</span><span class='line'>    <span class="c1"># Needs to be enabled in order to do automatic lookups.</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Placeholders</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">placeholder</span><span class="p">(</span><span class="n">wrapper_options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">input_html_options</span><span class="o">[</span><span class="ss">:placeholder</span><span class="o">]</span> <span class="o">||=</span> <span class="n">placeholder_text</span>
</span><span class='line'>        <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">placeholder_text</span>
</span><span class='line'>        <span class="n">placeholder</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:placeholder</span><span class="o">]</span>
</span><span class='line'>        <span class="n">placeholder</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="p">?</span> <span class="n">placeholder</span> <span class="p">:</span> <span class="n">translate_from_namespace</span><span class="p">(</span><span class="ss">:placeholders</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以看到，它修改的是 input 这个 StringInput 实例的 input_html_options 里的 placeholder 配置，然后返回 nil，
即没有 HTML 文本输出。</p>

<p>之所以能修改，是因为 component.render(input) 在这里是让 input 自己去调用自己的 placeholder 方法，
而 SimpleForm::Inputs::StringInput 继承了 SimpleForm::Inputs::Base， SimpleForm::Inputs::Base 这个类引用了
众多的 Components，因此 input 实例有了这些 components 所定义的方法。</p>

<h2>总结</h2>

<p>第一篇我们主要阐述了 SimpleForm 在 Rails 渲染表单这整个工作流的一个基本原理，
而这一篇我们主要从 SimpleForm::Wrappers、 SimpleForm::Inputs、SimpleForm::Components 这几个 namespace 下面
相关的类阐述了这几者在 wrapper 对表单控件进行包裹式地渲染这个过程所扮演的角色。</p>

<p>至此，你可以通过详细阅读 SimpleForm::Inputs::Base 的代码和一些 Components 的代码，并做一些练习，
即可完全掌握如何去编写一个 SimpleForm 的扩展。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/31/inspect-simple-form-1/">Inspect SimpleForm (1)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-31T00:02:37+08:00'><span class='date'>2015-05-31 00:02:37</span> <span class='time'>12:02 am</span></time>
        
           | <a href="/blog/2015/05/31/inspect-simple-form-1/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2015/05/31/inspect-simple-form-1/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Table of Content</h2>

<ul>
<li>简单介绍 SimpleForm 做了什么事情</li>
<li>如何编写一个简单的 wrapper</li>
<li>从 simple_form_for 这个入口了解 SimpleForm 的基本工作原理</li>
<li>深入了解 wrapper 的实现</li>
</ul>


<h2>简介</h2>

<p>SimpleForm 是 Rails 项目最常用的插件之一，通过抽象出 wrapper 这个概念来简化表单的编写。</p>

<p>通常情况下，网页上的表单都需要经过各种美化，这使得最后的表单控件会被
各种各样的标签所包裹，例如套用了 Bootstrap 的 Horizontal Form 的样式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%</span> <span class="n">form_for</span> <span class="n">resource</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-horizontal&#39;</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;div class=&quot;form-group&quot;&gt;</span>
</span><span class='line'><span class="x">    &lt;label for=&quot;inputEmail3&quot; class=&quot;col-sm-2 control-label&quot;&gt;Email&lt;/label&gt;</span>
</span><span class='line'><span class="x">    &lt;div class=&quot;col-sm-10&quot;&gt;</span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-control&#39;</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">&#39;Email&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    &lt;/div&gt;</span>
</span><span class='line'><span class="x">  &lt;/div&gt;</span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们不做进一步的抽象，那么在每个地方，我们都会重复地写这些代码，而且一旦需要修改，那么就是大面积的查找和替换了。
但如果你使用了 SimpleForm 之后，那么就会变成：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">simple_form_for</span> <span class="n">resource</span><span class="p">,</span> <span class="ss">wrapper</span><span class="p">:</span> <span class="ss">:horizontal_form</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;horizontal_form&#39;</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">input</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">input</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">button</span> <span class="ss">:submit</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>SimpleForm 会根据你所写的配置（<a href="https://github.com/plataformatec/simple_form/blob/master/lib%2Fgenerators%2Fsimple_form%2Ftemplates%2Fconfig%2Finitializers%2Fsimple_form_bootstrap.rb">例子</a>）
所指定的 wrapper 来对表单控件进行一层包裹，从而达到代码重用的效果。<br/>
wrapper 对于 SimpleForm 来讲是最核心的东西，现在我们来看看关于它的一些东西。</p>

<h2>如何编写 wrapper</h2>

<p>我们看看上面的 horizontal_form 这个 wrapper 是如何编写的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/initializers/simple_form_bootstrap3.rb</span>
</span><span class='line'><span class="no">SimpleForm</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">wrapper</span> <span class="ss">:horizontal_form</span><span class="p">,</span> <span class="ss">tag</span><span class="p">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-group&#39;</span><span class="p">,</span> <span class="ss">error_class</span><span class="p">:</span> <span class="s1">&#39;has-error&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:html5</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:placeholder</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">optional</span> <span class="ss">:maxlength</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">optional</span> <span class="ss">:pattern</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">optional</span> <span class="ss">:min_max</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">optional</span> <span class="ss">:readonly</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:input</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-control&#39;</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">wrap_with</span><span class="p">:</span> <span class="p">{</span> <span class="ss">tag</span><span class="p">:</span> <span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;help-block&#39;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:hint</span><span class="p">,</span>  <span class="ss">wrap_with</span><span class="p">:</span> <span class="p">{</span> <span class="ss">tag</span><span class="p">:</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;help-block&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>乍一看还挺多东西的，但是不怕，我们通过对比一些最终的输出内容我们就可以知道，最核心的下面这两行代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:input</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-control&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以，通过看一下文档和例子我们马上就可以掌握编写一个简单的 wrapper 了。<br/>
好了，最基本的介绍也到此为止了，而关于其他几行代码，究竟是什么意思，
究竟是如何工作的，接下来我会一一讲解。</p>

<h2>simple_form_for</h2>

<p>在对 wrapper 进行剖析之前，还是需要先来看看整个程序的入口：simple_form_for。这也是读源代码的方法，我们不能一下子就
把头埋进浩瀚的代码海洋中，我们要从入口来理清楚整个程序的逻辑。下面就是我找到的关键代码片段：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/simple_form/active_view_extensions/form_helper.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">SimpleForm</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ActionViewExtensions</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">FormHelper</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">simple_form_for</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:builder</span><span class="o">]</span> <span class="o">||=</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">FormBuilder</span>
</span><span class='line'>        <span class="c1"># 中间代码省略</span>
</span><span class='line'>        <span class="n">with_simple_form_field_error_proc</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">form_for</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">ActionView</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">send</span> <span class="ss">:include</span><span class="p">,</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">ActionViewExtensions</span><span class="o">::</span><span class="no">FormHelper</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面的代码也就可以看出，这个方法做了两件事：</p>

<ol>
<li>设置 form_for 的 builder 为 SimpleForm::FormBuilder，即 f 是这个类的实例</li>
<li>调用 Rails 原生提供的 form_for 这个 helper 来渲染整个表单</li>
</ol>


<p>所以，接下来就是找到 SimpleForm::FormBuilder 这个文件了，在这个文件里，我们就可以找到关键的接口 <code>input</code> 了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="n">options</span> <span class="o">=</span> <span class="vi">@defaults</span><span class="o">.</span><span class="n">deep_dup</span><span class="o">.</span><span class="n">deep_merge</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@defaults</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">input</span>   <span class="o">=</span> <span class="n">find_input</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="n">wrapper</span> <span class="o">=</span> <span class="n">find_wrapper</span><span class="p">(</span><span class="n">input</span><span class="o">.</span><span class="n">input_type</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">wrapper</span><span class="o">.</span><span class="n">render</span> <span class="n">input</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法里做了三件事：</p>

<ol>
<li>找到 attribute 对应的控件（如 String Input, File Input, etc）</li>
<li>找到对应的 wrapper（如 config.wrapper :horizontal &hellip;）</li>
<li>让 wrapper 来将表单控件进行包裹式的渲染，得到我们最终想要的效果</li>
</ol>


<p>至此， SimpleForm 最基本的工作流我们已经掌握了，接下来，让我们深入 Wrapper 的内部。</p>

<h2>从 SimpleForm.setup 开始</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SimpleForm</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">wrappers</span> <span class="ss">:horizontal_form</span><span class="p">,</span> <span class="ss">tag</span><span class="p">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-group&#39;</span><span class="p">,</span> <span class="ss">error_class</span><span class="p">:</span> <span class="s1">&#39;has-error&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span>
</span><span class='line'>    <span class="c1">#...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>config.wrappers ...</code> 发生了什么事情， 即 SimpleForm 是如何维护这些 wrappers，其实秘密就藏在这里面。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/simple_form.rb</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="n">mattr_accessor</span> <span class="ss">:default_wrapper</span>
</span><span class='line'>  <span class="vc">@@default_wrapper</span> <span class="o">=</span> <span class="ss">:default</span>
</span><span class='line'>  <span class="vc">@@wrappers</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>  <span class="c1"># Define a new wrapper using SimpleForm::Wrappers::Builder</span>
</span><span class='line'>  <span class="c1"># and store it in the given name.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">wrappers</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">block_given?</span>
</span><span class='line'>      <span class="n">options</span>                 <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_options!</span>
</span><span class='line'>      <span class="nb">name</span>                    <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="ss">:default</span>
</span><span class='line'>      <span class="vc">@@wrappers</span><span class="o">[</span><span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span>   <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="vc">@@wrappers</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># Builds a new wrapper using SimpleForm::Wrappers::Builder.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">build</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:tag</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:div</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:tag</span><span class="o">].</span><span class="n">nil?</span>
</span><span class='line'>    <span class="n">builder</span> <span class="o">=</span> <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Wrappers</span><span class="o">::</span><span class="no">Builder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">yield</span> <span class="n">builder</span>
</span><span class='line'>    <span class="no">SimpleForm</span><span class="o">::</span><span class="no">Wrappers</span><span class="o">::</span><span class="no">Root</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">to_a</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面的源代码可以看出，这些 wrapper 被放在了类变量 wrappers 这个 Hash 实例对象里了。
它是一个 wrapper_name 对应着 SimpleForm::Wrapper::Root 实例的形式，也就是说，我们可以通过这样的形式访问到我们刚配置的
horizontal_form 这个内容，我们到 rails console 试着把这个打印出来</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">4</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">Frame</span> <span class="ss">number</span><span class="p">:</span> <span class="mi">0</span><span class="o">/</span><span class="mi">5</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span><span class="no">SimpleForm</span><span class="o">.</span><span class="n">wrappers</span><span class="o">[</span><span class="s1">&#39;horizontal_form&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;SimpleForm::Wrappers::Root:0x007fedd7263b18</span>
</span><span class='line'> <span class="vi">@components</span><span class="o">=</span>
</span><span class='line'>  <span class="o">[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298660 @namespace=:html5, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd72985e8 @namespace=:placeholder, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298598 @namespace=:maxlength, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298520 @namespace=:pattern, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd72984d0 @namespace=:min_max, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298458 @namespace=:readonly, @options={}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd72983b8 @namespace=:label, @options={:class=&gt;&quot;col-sm-3 control-label&quot;}&gt;,</span>
</span><span class='line'>   <span class="c1">#&lt;SimpleForm::Wrappers::Many:0x007fedd7263be0</span>
</span><span class='line'>    <span class="vi">@components</span><span class="o">=</span>
</span><span class='line'>     <span class="o">[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7298188 @namespace=:input, @options={:class=&gt;&quot;form-control&quot;}&gt;,</span>
</span><span class='line'>      <span class="c1">#&lt;SimpleForm::Wrappers::Single:0x007fedd7263fa0</span>
</span><span class='line'>       <span class="vi">@component</span><span class="o">=</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263f78 @namespace=:error, @options={}&gt;,</span>
</span><span class='line'>       <span class="vi">@components</span><span class="o">=[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263f78 @namespace=:error, @options={}&gt;],</span>
</span><span class='line'>       <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;help-block&quot;</span><span class="o">]</span><span class="p">},</span>
</span><span class='line'>       <span class="vi">@namespace</span><span class="o">=</span><span class="ss">:error</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>      <span class="c1">#&lt;SimpleForm::Wrappers::Single:0x007fedd7263cf8</span>
</span><span class='line'>       <span class="vi">@component</span><span class="o">=</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263ca8 @namespace=:hint, @options={}&gt;,</span>
</span><span class='line'>       <span class="vi">@components</span><span class="o">=[</span><span class="c1">#&lt;SimpleForm::Wrappers::Leaf:0x007fedd7263ca8 @namespace=:hint, @options={}&gt;],</span>
</span><span class='line'>       <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;help-block&quot;</span><span class="o">]</span><span class="p">},</span>
</span><span class='line'>       <span class="vi">@namespace</span><span class="o">=</span><span class="ss">:hint</span><span class="o">&gt;]</span><span class="p">,</span>
</span><span class='line'>    <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;col-sm-9&quot;</span><span class="o">]</span><span class="p">},</span>
</span><span class='line'>    <span class="vi">@namespace</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;]</span><span class="p">,</span>
</span><span class='line'> <span class="vi">@defaults</span><span class="o">=</span><span class="p">{</span><span class="ss">:tag</span><span class="o">=&gt;</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;[</span><span class="s2">&quot;form-group&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:error_class</span><span class="o">=&gt;</span><span class="s2">&quot;has-error&quot;</span><span class="p">,</span> <span class="ss">:maxlength</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:pattern</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:min_max</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:readonly</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">},</span>
</span><span class='line'> <span class="vi">@namespace</span><span class="o">=</span><span class="ss">:wrapper</span><span class="p">,</span>
</span><span class='line'> <span class="vi">@options</span><span class="o">=</span><span class="p">{</span><span class="ss">:maxlength</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:pattern</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:min_max</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:readonly</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">}</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以我们找到了关键的点了，那就是 <code>SimpleForm::Wrappers::Root</code> ，打开这个源代码文件之后，我们可以发现它继承了
<code>SimpleForm::Wrappers::Many</code>，并且主要的方法 <code>render</code> 也是在这个类里面。</p>

<h2>SimpleForm::Wrappers::Many</h2>

<p>找到 render 方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">html_safe</span>
</span><span class='line'>  <span class="n">options</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">options</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">components</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">component</span><span class="o">|</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="n">component</span><span class="o">.</span><span class="n">namespace</span><span class="o">]</span> <span class="o">==</span> <span class="kp">false</span>
</span><span class='line'>    <span class="n">rendered</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">content</span><span class="o">.</span><span class="n">safe_concat</span> <span class="n">rendered</span><span class="o">.</span><span class="n">to_s</span> <span class="k">if</span> <span class="n">rendered</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">wrap</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以看到，它是将每个 component 通过传入 input （上面讲 simple_form_for 的那段代码的 input） 这个变量后渲染并拼接
所有 component 的输出内容后，通过 wrapper 方法，再将这个内容包括并输入渲染到 view 里去的。例如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:input</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-control&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码套在这个思路上就是</p>

<ol>
<li>输出 label 的 HTML 内容</li>
<li>输出表单控件的 HTML 内容</li>
<li>拼接这两段 HTML</li>
<li>用一个 div 将这段拼接后的 HTML 包裹起来然后输出到 view 里</li>
</ol>


<p>所以， SimpleForm 内部 wrapper 的工作原理就大致如此，但我们掌握得还远远不够，我们还需要深挖下去。<br/>
例如除了上面那两行代码，其他的代码是做什么的，又是怎么样做的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:html5</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">use</span> <span class="ss">:placeholder</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">optional</span> <span class="ss">:maxlength</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">optional</span> <span class="ss">:pattern</span>
</span></code></pre></td></tr></table></div></figure>


<p>例如从 Rails Console 里的输出我们还看到了几个类，它们又是什么。</p>

<ul>
<li>SimpleForm::Wrappers::Leaf</li>
<li>SimpleForm::Wrappers::Single</li>
<li>SimpleForm::Wrappers::Builder</li>
</ul>


<p>这些我将在下一篇阐述清楚。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/16/captcha-in-ruby/">Captcha in Ruby</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-16T11:35:41+08:00'><span class='date'>2015-05-16 11:35:41</span> <span class='time'>11:35 am</span></time>
        
           | <a href="/blog/2015/05/16/captcha-in-ruby/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2015/05/16/captcha-in-ruby/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>图片验证码的使用场景就不用说了，在这里分享一下我是如何做登录图片验证码的。</p>

<h2>图片验证码的生成的简单流程</h2>

<p><code>生成验证码字符</code> -> <code>生成图片验证码</code> [-> <code>使用</code>]</p>

<p>第三步的意思是，当你拿到图片验证码时，看你的具体需求了，是直接随着 form 表单渲染，
还是浏览器异步地请求图片验证码，或者其它什么的，反正无所谓了。</p>

<h2>谈一谈 simple_captcha2 的做法</h2>

<p>simple_captcha2 是基于 ImageMagick 来生成图片，基于数据库来存储验证码数据的。
提供了 <code>Controller Based</code> 和 <code>Model Based</code> 两种用法。</p>

<p><strong>Controller Based</strong></p>

<p>simple_captcha2 提供了一对方法： <code>show_simple_captcha</code> 和 <code>simple_captcha_valid?</code>。
前者是一个 view helper，让我们能够在某个地方显示一张验证码图片，后者让我们可以去判定用户提交的验证码是否正确。
想知道更多的用法可以移步到<a href="https://github.com/pludoni/simple-captcha">它的文档</a>。</p>

<p><strong>实现原理</strong></p>

<p>simple_captcha2 基于数据库维护了一对 key -> value 数据，数据结构如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                                 Table "public.simple_captcha_data"
</span><span class='line'>   Column   |            Type             |                            Modifiers
</span><span class='line'>------------+-----------------------------+------------------------------------------------------------------
</span><span class='line'> id         | integer                     | not null default nextval('simple_captcha_data_id_seq'::regclass)
</span><span class='line'> key        | character varying(40)       |
</span><span class='line'> value      | character varying(6)        |
</span><span class='line'> created_at | timestamp without time zone |
</span><span class='line'> updated_at | timestamp without time zone |
</span><span class='line'>Indexes:
</span><span class='line'>"simple_captcha_data_pkey" PRIMARY KEY, btree (id)
</span><span class='line'>"simple_captcha_data_key" btree (key)</span></code></pre></td></tr></table></div></figure>


<p>当我们调用 <code>show_simple_captcha</code> 时就会生成一对这样的值，然后存放到数据库（MySQL|Postgresql|Redis）， 然后在 view 里生成这样的内容。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span><span class="err">,</span> <span class="na">name=</span><span class="s">&quot;captcha_key&quot;</span> <span class="na">value=</span><span class="s">&quot;d850ec25ca962ba6606cfe7c84f9568c8473e93e&quot;</span>
</span><span class='line'><span class="err">&lt;</span><span class="na">img</span> <span class="na">alt=</span><span class="s">&quot;captcha&quot;</span> <span class="na">src=</span><span class="s">&quot;/simple_captcha?code=d850ec25ca962ba6606cfe7c84f9568c8473e93e&amp;time=1431749439&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样，它的工作原理就很清楚了。</p>

<p>key 的生成算法如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="o">[</span><span class="n">session</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;captcha&quot;</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">join</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>value 的算法如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">generate_simple_captcha_data</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span><span class='line'>  <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">code</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;numeric&#39;</span> <span class="k">then</span>
</span><span class='line'>      <span class="no">SimpleCaptcha</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">times</span><span class="p">{</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">48</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">chr</span><span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="no">SimpleCaptcha</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">times</span><span class="p">{</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">65</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">26</span><span class="p">))</span><span class="o">.</span><span class="n">chr</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">value</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>simple_captcha 实现了一个 middleware， 以返回验证码图片。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">SimpleCaptcha</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Middleware</span>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">captcha_path?</span><span class="p">(</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>        <span class="n">make_image</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">make_image</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">404</span><span class="p">)</span>
</span><span class='line'>      <span class="n">request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>      <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">[</span><span class="s2">&quot;code&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">body</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">!</span><span class="n">code</span><span class="o">.</span><span class="n">blank?</span> <span class="o">&amp;&amp;</span> <span class="no">Utils</span><span class="o">::</span><span class="n">simple_captcha_value</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">generate_simple_captcha_image</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span> <span class="ss">:disposition</span> <span class="o">=&gt;</span> <span class="s1">&#39;inline&#39;</span><span class="p">,</span> <span class="ss">:filename</span> <span class="o">=&gt;</span>  <span class="s1">&#39;simple_captcha.jpg&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="c1">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>在生成验证码图片这一步，它是调用了 ImageMagick 的命令来生成图片的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expected_outcodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="n">command</span> <span class="o">=</span> <span class="sx">%Q[</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="sx"> </span><span class="si">#{</span><span class="n">params</span><span class="si">}</span><span class="sx">]</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2"> 2&gt;&amp;1&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">unless</span> <span class="p">(</span><span class="n">image_magick_path</span> <span class="o">=</span> <span class="no">SimpleCaptcha</span><span class="o">.</span><span class="n">image_magick_path</span><span class="p">)</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>    <span class="n">command</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_magick_path</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># convert -size 100x100 -gravity &quot;Center&quot; -implode 0.2 &lt;path/to/file&gt;</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">=</span> <span class="sb">`</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">unless</span> <span class="o">[</span><span class="n">expected_outcodes</span><span class="o">].</span><span class="n">flatten</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vg">$?</span><span class="o">.</span><span class="n">exitstatus</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="o">::</span><span class="no">StandardError</span><span class="p">,</span> <span class="s2">&quot;Error while running </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>总结</strong></p>

<p>分三步走：</p>

<ol>
<li>生成一组 key, value，然后存进数据库</li>
<li>浏览器根据 key 请求验证码图片</li>
<li>根据 key 从数据库里取出 value，然后判定用户提交的验证码是否正确</li>
</ol>


<h2>我是这么做的</h2>

<p>simple_captcha2 为图片验证码提供了一整套的解决方案，在 Rails 里使用非常简单。
但仍有做得不足的地方，例如没有暴露生成验证码图片的接口给我们，使得我们能够直接通过 ajax 来请求验证码图片。
虽然可以通过 mokey patch 来做的，但是我自己想了一个更简单的方案。</p>

<p>我的思路：</p>

<ol>
<li>生成验证码字符串</li>
<li>根据字符串生成验证码图片</li>
<li>将验证码字符串放到 session 里</li>
<li>将图片编码成 Base64 字符串，剩下的就看你的使用场景</li>
</ol>


<p>伪代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># in someone controller</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># GET /captcha</span>
</span><span class='line'><span class="k">def</span> <span class="nf">captcha</span>
</span><span class='line'>  <span class="n">text</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">upcase</span>
</span><span class='line'>  <span class="n">session</span><span class="o">[</span><span class="ss">:captcha</span><span class="o">]</span> <span class="o">=</span> <span class="n">text</span>
</span><span class='line'>  <span class="n">base64Image</span> <span class="o">=</span> <span class="no">Captcha</span><span class="o">.</span><span class="n">generate</span> <span class="n">text</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">40</span>  <span class="c1"># 验证码的内容，图片的宽度，图片的高度</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="p">{</span> <span class="ss">image</span><span class="p">:</span> <span class="n">base64Image</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最关键的就是如何实现 <code>Captcha.generate</code> 了，使用纯 Ruby 生成图片成本高，需要许多知识，所以我还是选择了依赖于 ImageMagick。
思路也很简单：</p>

<ol>
<li>根据参数，生成关于 ImageMagick 中的 <code>convert</code> 命令所需要的参数</li>
<li>使用系统调用来生成图片，并放在一个临时目录里</li>
<li>读取图片的内容，完成后关闭这个临时文件，最后把图片内容返回</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Captcha</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">generate</span> <span class="n">text</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">28</span>
</span><span class='line'>    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">upcase</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">params</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;-fill darkblue&#39;</span><span class="p">,</span> <span class="s1">&#39;-background white&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;-size </span><span class="si">#{</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">#{</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;-wave </span><span class="si">#{</span><span class="n">distortion</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-gravity &quot;Center&quot;&#39;</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-pointsize 22&#39;</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-implode 0.2&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dst</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;neolion_captcha&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="o">]</span><span class="p">,</span> <span class="no">Dir</span><span class="o">::</span><span class="n">tmpdir</span><span class="p">)</span>
</span><span class='line'>    <span class="n">dst</span><span class="o">.</span><span class="n">binmode</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;label:&#39;</span><span class="si">#{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\&quot;</span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">dst</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dst</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">read_as_base64</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">dst</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">distortion</span>
</span><span class='line'>      <span class="o">[</span><span class="mi">0</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">80</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run</span> <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expected_outcodes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">command</span> <span class="o">=</span> <span class="sx">%Q[convert </span><span class="si">#{</span><span class="n">params</span><span class="si">}</span><span class="sx">]</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2"> 2&gt;&amp;1&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">output</span> <span class="o">=</span> <span class="sb">`</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">unless</span> <span class="o">[</span><span class="n">expected_outcodes</span><span class="o">].</span><span class="n">flatten</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vg">$?</span><span class="o">.</span><span class="n">exitstatus</span><span class="p">)</span>
</span><span class='line'>        <span class="k">raise</span> <span class="o">::</span><span class="no">StandardError</span><span class="p">,</span> <span class="s2">&quot;Error while running </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">output</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">read_as_base64</span> <span class="n">filepath</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">binread</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
</span><span class='line'>      <span class="o">[</span><span class="s1">&#39;data:image/png;base64,&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">].</span><span class="n">join</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>至于判定用户的验证码是否正确，就很简单了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">valid_captcha?</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:captcha</span><span class="o">]</span> <span class="o">==</span> <span class="n">params</span><span class="o">[</span><span class="ss">:captcha</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<ul>
<li><a href="http://en.wikipedia.org/wiki/Digital_image">http://en.wikipedia.org/wiki/Digital_image</a></li>
<li><a href="http://www.webascender.com/Blog/ID/529/Working-with-Bits-and-Bytes-in-Ruby#.VUuBvROUe58">http://www.webascender.com/Blog/ID/529/Working-with-Bits-and-Bytes-in-Ruby#.VUuBvROUe58</a></li>
<li><a href="http://www.imagemagick.org/script/index.php">http://www.imagemagick.org/script/index.php</a></li>
<li><a href="https://github.com/minimagick/minimagick">https://github.com/minimagick/minimagick</a></li>
<li><a href="https://github.com/minimagick/minimagick/issues/59">https://github.com/minimagick/minimagick/issues/59</a></li>
<li><a href="https://github.com/wvanbergen/chunky_png">https://github.com/wvanbergen/chunky_png</a></li>
<li><a href="https://github.com/wvanbergen/oily_png">https://github.com/wvanbergen/oily_png</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/25/last-two-years/">审视自己</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-25T10:33:03+08:00'><span class='date'>2015-04-25 10:33:03</span> <span class='time'>10:33 am</span></time>
        
           | <a href="/blog/2015/04/25/last-two-years/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2015/04/25/last-two-years/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>工作两年零一个月</h2>

<p>2013年10月份，我开始用 Evernote 来记录我每天做的主要的工作情况和学习的情况。
至今，我仍然保持着这种习惯。</p>

<p>从今年开始，我越来越觉得生命十分短暂，我都已经毕业快两年了，加上实习的时间，
我工作已经有2年+1个月了。</p>

<p>本该在学校里完成的学习能力、思维能力等方面的提高，我却没有掌握这个重点，
付出的努力的质量很低，这是我在毕业参加工作后的深刻体会。</p>

<p>2015年4月23日，也就是前天，我又再一次问自己，你清楚自己现在所处的状态么？
在跟朋友简短地聊天之后，朋友建议我回过头去看看过去两年的日志，看能否找到
些什么？</p>

<p>得益于长期坚持下来的记录，让我能够详细地去了解过去一年多的时间里每周所做
的主要的事情。</p>

<h2>回顾</h2>

<p>我花了一个多小时整理了所有的日志，用时间轴的方式罗列出了从2013年10月份开始，
每个月我所做的事情，其结果让我十分震惊。</p>

<p><strong>2013年10月份前</strong></p>

<p>实习和毕业的事情是我生活的全部。</p>

<p><strong>2013年10月至2014年1月</strong></p>

<p>工作、学习，以及对于学习、生活的思考几乎是我生活的全部。</p>

<p>期间，恺哥对于我的关于专业学习上的指导，让我深刻意识到我过去15年的学习方式
存在着重大的问题，也就是从这时候开始，我开始反思我的过去，开始思考如何改变。</p>

<p>这是我迄今为止最为难忘的几个月，也就是从这样的一个时刻之后，我开始有意识地，全方位地确立我自己的三观。</p>

<p><strong>2014年2月至2014年11月</strong></p>

<p>在这段时间，从我的记录来看，我的生活，几乎都是与工作相关的内容，其他方面的记录非常少，但我仍然记得在7月份到9月份期间里，我几乎停止了学习，这是对生命的严重浪费。</p>

<p><strong>2014年12月至今</strong></p>

<p>因为公司战略转移的缘故，我有了更多的时间来学习。在这段时间里，我补习了一些计算机
相关的基础知识，也开始了解服务器监控、日志、Hadoop等一些东西，知识面扩充了不少。
最近一个月则转向了前端框架 Ember，最后抛弃了 Ember，转向 React，
在折腾前端的这一个月里，有时候十分地难过，有关于框架本身的，有关于抱怨自己总是不能抓到重点的时刻。但总体来说，十分地充实、欢乐。</p>

<h2>审视自己</h2>

<p>对于自己的生活，一直都没有一个有效的规划和有效的推进。
我问了自己一个问题是：一年的时间，我究竟能做多少事情，一个月呢，一周呢。</p>

<p><strong>日志告诉了我答案</strong></p>

<p>对于日常的各种知识的学习，一个月，我的平均产出几乎稳定在3，也就是3件中等的工作量。
于此同事，在工作上，平均产出也基本是3，最低时为1，最高时能达到5。
也就是说，日常的工作，并且学习如果是与工作相关的话，那么一个月能达到6到7。</p>

<p>这里的一个工作量，应该就是 30 / (3 + 3) = 5，即5个工作日。
例如学习和掌握 React 基本的使用所需的时间对于我来说是一个工作量。</p>

<p>也就是说，一年的时间里，如果一直保持比较好的状态，那么我的知识积累的量能到36，
工作上如果产品稳定迭代，那么也能到36甚至更高，不过这还是跟具体的情况有关。</p>

<h2>目标</h2>

<p>在接下来的时间里，我想去验证我的这一个答案，看自己是否真的在8周的时间里做到不影响工作的情况下，然后自己的知识积累产出为6（不包含工作上的任务）。</p>

<p>当前，把这个 <strong>6</strong> 给分解掉</p>

<ul>
<li>书籍《伟大的博弈》（已看了一半），1</li>
<li>书籍《历代经济变革得失》到第十讲，1</li>
<li>书籍《深入浅出Node》, 1</li>
<li>sprockets &amp; sprocket-rails 的源码, 2</li>
<li>用 Ruby 实现一个 Event Loop, 1</li>
</ul>


<p>截止日期为2015-06-20，感觉仍然会有问题，但具体到时候再调整。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/03/deep-thinking-about-my-2014/">2014 沉思录</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-03T11:30:51+08:00'><span class='date'>2015-01-03 11:30:51</span> <span class='time'>11:30 am</span></time>
        
           | <a href="/blog/2015/01/03/deep-thinking-about-my-2014/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2015/01/03/deep-thinking-about-my-2014/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这是我第一次在博客里写总结，在以往的几年里，都是写了然后发布在QQ空间里，都是以“XXXX 沉思录”命名。<br/>
这次，也同样以这样的名字规则命名。<br/></p>

<p>2014，对于我来说，是非常普通的一年。<br/>
计划要做的事情有一半没有完成，计划之外的，也有一些收获。</p>

<h2>有必要谈谈的过去</h2>

<blockquote><p>德国两百年前的教育宣言曾经如此说到：教育的目的，不是培养人们适应传统的世界，不是着眼于实用性的知识和技能，
而是要去唤醒学生的力量，培养他们自我学习的主动性、抽象的归纳力和理解力，以便使他们在目前无法预料的种种未来
局势中，自我作出有意义的选择。</p></blockquote>

<p>这是我在 2012 年间看到的一段话，对我的影响巨大，它颠覆了我以往对于读书的观念，启蒙我去探索教育对于我个人的真正
意义，以及自身存在的意义。</p>

<p>2013 年 3 月，我来到杭州实习，开始工作，在这过程中，发现了许许多多的自身存在的问题，一些很本质的问题。<br/>
2013 年 6 月，我正式毕业，这才猛然发现，对于这座学院，我有着许多的不舍，也同时发现，有许多事情，我都没有做好。</p>

<p>那两年里，对于我来说，最重要的收获就是找到了自己的信仰，或者说信念，以及对于生命体存在的方式的思考。<br/>
这也奠定了我的 2014 的方向。</p>

<h2>2014</h2>

<p>2014 我以<strong>“补习专业基础”</strong>六字作为我专业技术学习上的总指导思想，这是在 2013 年底里所决定的事情。<br/>
围绕着这个指导思想，我制定了一个简单的计划，即阅读几本书计算机书籍。</p>

<ul>
<li>Structure and Interpretation of Computer Programs，计算机程序的构造与解释</li>
<li>Computer Systems，深入理解计算机系统</li>
<li>Introduction to Algorithms，算法导论</li>
<li>Compilers，编译原理</li>
<li>Computer Networking，计算机网络</li>
</ul>


<p>实际完成的情况，当然非常差。<br/>
SICP 看了三分之一就已经快崩溃了，后面的章节时粗略地翻看了一遍，就放下这本书了。<br/>
而对于深入理解计算机系统，也是看了前面几章，后面就没看了，当然，这过程发生了一些转折点。<br/>
而对于剩下的三本书，完全没看。</p>

<p>在这一年里，围绕着一个产品需要的工具，还接触了如前端数据可视化的 d3js、highchart，了解 chef、munin、monit、logstash、elasticsearch、emberjs、grunt 等。</p>

<p>在 11 月份的时候，我接触到了网易云课堂这个东西。我在上面学习了几个我感兴趣的课程。例如：摄影基础、如何阅读一本书。
在专业知识方面，我学习了《Linux 入门基础》，填充了我在 Linux 系统学习这方面的空白。
目前在复习的课程则有数据结构和编译原理，数据结构毕业后荒废了，而编译原理则经常逃课。</p>

<h2>一些收获</h2>

<p><strong>《如何阅读一本书》</strong></p>

<p>  正如这本书的名字，它让我了解到读书分为几个层次，以及如何去阅读一本书。弥补了我在提炼知识方法这方面的空白。<br/>
  其中的主题阅读方式，还应该应用到知识点的学习掌握上，这一点，我也是最近才深刻意识到。<br/>
  在整个上学的生涯里，我很痛心的就是我从来没有意识到这一点，或者说没有实践到。</p>

<p><strong> 人之所以不能成功，不是因为没有足够的毅力，而是缺乏掌握科学的方法 </strong></p>

<p>  这句话让我认识，寻找一个适合自己的，让自己更加容易坚持下去的方法对于实现你的想法至关重要。<br/>
  在《把你的英语用起来》这本书里的第一章里也提到过，人的心智力量也是需要培养和呵护的。<br/>
  这是现在的我，在实践自己的想法的一个指导思想，越来越清楚需要长时间的付出，不再那么容易气馁。<br/>
  2014 年的计划之所以完成地太少，很大程度上是我没有做到这一点。</p>

<p><strong> 人生最大的困惑在于，在不同的阶段没有方向，没有指引 </strong></p>

<p>  在很多时候，人经常所面临的问题是，不清楚究竟需要多少时间，多少努力才能实现心中所想。<br/>
  乔布斯说过一句话：在做事情我总问为什么。虽然总的一年的方向我是有的，可是在不同的时间点里，<br/>
  我没有及时地去根据自己当前的情况来调整自己的方向，以至于在第三季度，我整整荒废了3个月（不过我终于学会了蛙泳）。<br/>
  多问为什么要这么做，肯定可以发现更多的问题。</p>

<p><strong> 韩寒的处女作电影《后会无期》 </strong></p>

<p>  和喜欢的事物在一起</p>

<p>  这部电影里有很多值得深思和去体会的句子，对于我来说最深刻的是韩寒说过的一句话：和自己喜欢的事物在一起。<br/>
  人并不是一台工作机器，还是要努力去找到自己喜欢的一切。<br/></p>

<p>  我是谁</p>

<p>  剥离掉所有外界赋予的定位和枷锁，不讲职业规划，不讲人生规划，你又是谁？<br/>
  人活着最重要的是经历、兴趣，和感知。<br/></p>

<p>  关于相聚</p>

<p>  能相聚时，就好好珍惜，因为下一次再见，我们都不知道是什么时候，可能会再见也可能不会。</p>

<h2>接下来</h2>

<p>  对于我来说，2014 真正的终点并未到达，深知脚下的路才刚迈开，需要时间，需要努力的积累。<br/>
  对于我来说，接下来的路，还是以基础为主的积累，结合项目向四周的网络结点扩散。<br/>
  对于我来说，需要更多的是感恩，感恩公司这个平台，感恩在这过程中给我帮助和指导的同事。</p>

<p>  作为一个程序员，我没有改变世界的伟大梦想，我只有一颗强烈追寻内心信念的心。</p>

<p>  2014，我不会清空，每一份经历对于我来说都十分宝贵，怎么舍得清空。<br/>
  2015，我打算以一个没有计划的计划，随心前进，信念会引领接下来的路，时间会帮我拨开眼前的雾。</p>

<p>  最近的一段日子，不太适合做总结的事情，因为一直都没有办法进入一个深度思考的状态，很多文字其实都很难恰当地表达内心最真实的想法。
  不过也无所谓了，在春节后，我还会再写一篇完整的沉思录来总结和阐述我的2014年。</p>

<p>  Thanks for reading.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/31/rails-threadsafe/">What Is config.threadsafe!（译）</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-31T16:37:32+08:00'><span class='date'>2014-12-31 16:37:32</span> <span class='time'>4:37 pm</span></time>
        
           | <a href="/blog/2014/12/31/rails-threadsafe/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/12/31/rails-threadsafe/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.sitepoint.com/config-threadsafe/">原文</a></p>

<p>我们都喜欢 Rails，因为它提供了许多优雅的功能让我们来完成我们的任务。
Rails 丰富的功能使得开发着更加专注于应用本身，而不是数据库查询、路由管理、
模板连接等一系列琐碎和重复的事情。</p>

<p>在为开发者提供许多用于 web 应用开发的功能的同时，Rails 隐藏了许多的细节。
因为 Rails 不想让你在构建一些好用功能的时候去关心底层所发生的事情。
开发者可以随时去阅读 Rails 的源码，而这种情况通常是发生在你的应用开始变得越来越大的时候。</p>

<p>初级和中级的开发者，经常会发现难以去理解 Rails 的一些很重要的概念，例如 Rack、Rack Middleware、ActiveRecord、Asset Pipeline、thread safety 等等。
在这篇文章里，我将会专注讲线程安全（thread safety）这一点。</p>

<p>现在让我们先谈谈多线程（multithreading）。多线程是计算机科学里一个非常重要的概念，
在今天我们必须要了解线程的重要性。线程随处可见，通常用来执行非常重要的工作。
请参考 <a href="http://en.wikipedia.org/wiki/Thread_%28computing%29">Wikipedia</a></p>

<blockquote><p>In computer science, a thread of execution is the smallest sequence of programmed instructions that can be managed independently by an operating system scheduler. A thread is a light-weight process.</p></blockquote>

<p>就如 Wikipedia 所说的，线程是一个轻量级的进程（a linght-weight process）。
多个线程同属于一个进程，并且共享着该进程的资源。
所以，就内存方面而言，线程比进程更加经济一些（more economical）。
在 web 环境里，线程经常用来处理一些 background job 或者是用来异步地去跑一个长时间运行的任务。
但是在使用多线程时，我们必须非常小心，否则特别是在多线程系统里当出现竞态的时候
我们可能会得到一个意想不到的结果。
请参考 <a href="http://en.wikipedia.org/wiki/Race_condition#Software">Wikipedia</a></p>

<blockquote><p>Race conditions arise in software when separate computer processes or threads of execution depend on some shared state. Operations upon shared states are critical sections that must be mutually exclusive. Failure to obey this rule opens up the possibility of corrupting the shared state.</p></blockquote>

<p>我们在计算机科学里已经了解到了一个有用的概念，现在让我们开始介绍 Rails 里的
线程安全（thread safety）。线程安全在 Rails 中已经不是一个新鲜的东西了，事实上，它可以追溯到 Rails 2.3.* 版本。Josh Peek 那时候就已经做了非常出色的工作来保证 Rails 代码是线程安全的。
Rails 里的线程安全避免了上面提到的竞态情况（race conditions）。</p>

<p>也就是说，在一个多线程的 web-server environment 里，我们的代码是需要线程安全的。
如果多线程在处理我们的 web 应用时，当所有的线程结束处理之后，我们的共享数据（shared data）就不应该出错。</p>

<p>但是 Rails 不能保证线程安全，因为开发者可能会犯错误，以至于使得代码是非线程安全的。
所以，Rails 要如何来保证我们的代码是线程安全的呢？</p>

<p>Rails 默认地，加了一个中间件（middleware）叫 “Rack::Lock” 到我们的 middleware stack 里。
这个 middleware 默认是 stack 里的第二个 middleware。
如果你想要查看，你可以在你的项目目录下执行 <code>rake middleware</code> 来查看。</p>

<p>第一个 middleware，是 <code>ActionDispatch::Static</code>，是用来处理静态资源的，
例如：JavaScript、CSS 文件和图片。</p>

<p>Rack::Lock 保证了每次只有一个线程在运行。如果我们移除了这个 middleware，那么多个线程就能够同时执行了。MIR Ruby 在 1.9 版本里有一个机制叫 <code>GIL (Global Interpreter Lock)</code> or <code>GVL (Global VM Lock/ Giant VM Lock)</code>。这个 GIL 保证了每次只有一个线程在运行，在多线程的情况下，它负责线程之间的上下文切换。
如果当前的线程正在等待一个I/O操作完成的话，Ruby 会自动切换到其他线程去处理新来的请求。</p>

<p>现在让我们来练习一个 Rails 里的线程安全。</p>

<p>Create a sample Rails app.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new test_app</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<p>Now <code>cd</code> into newly created Rails project and bundle to install the necessary gems.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle install</span></code></pre></td></tr></table></div></figure>


<p>After this, create a controller with some basic actions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails generate controller thread_safety index simple infinite</span></code></pre></td></tr></table></div></figure>


<p>这将会创建一个控制器 <code>ThreadSafetyController</code>，同时有 <code>index, simple, infinite</code> 三个 action。
打开 <code>app/views/thread_safety/index.html.erb</code> 文件，并粘贴进下面的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;simple_request&quot;</span><span class="nt">&gt;</span>Simple Request<span class="nt">&lt;/button&gt;</span>
</span><span class='line'><span class="ni">&amp;nbsp;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;infinite_request&quot;</span><span class="nt">&gt;</span>Infinite Request<span class="nt">&lt;/button&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#simple_request&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/users/simple&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">alert</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#infinite_request&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/users/infinite&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">alert</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个将会创建一个包含两个按钮的页面。目的是为了发送一个 ajax 请求到它们对应的 action，
并且在 alert box 里展示返回的结果。</p>

<p>现在让我们增加一些服务段的代码到这个文件里 <code>app/controllers/thread_safety_controller.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">simple</span>
</span><span class='line'>  <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Welcome from simple method&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">infinite</span>
</span><span class='line'>  <span class="k">while</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码是非常简单的。simple 这个 action 在 sleep 1 秒钟之后，就会渲染一个 text/plain 格式的响应
回客户端。而 infinite 这个 action 由于死循环的关系则永远不会返回结果。
现在在终端输入 <code>rails s</code>，并打开浏览器，输入 <a href="http://localhost:3000/thread_safety/index">http://localhost:3000/thread_safety/index</a></p>

<p>点击 simple 这个按钮，然后等一秒钟，你将会收到一个响应。现在点击 infinite 按钮等待服务端的响应。</p>

<p>infinite 用于不会返回结果，由于这个 action 里面有一段死循环的代码。
现在请你再一次点击 simple 按钮，你会发现服务器永远不会返回结果。</p>

<p>这就是线程安全。Rails 每次只允许一个线程在运行，这样保证了我们的代码是线程安全的。
没有其它的线程能够运行除非当前正在运行的线程结束。
因为 infinite 这个 action 里死循环的缘故，所以其他线程永远不会有机会运行并处理请求。</p>

<p>即使我们在生产环境里运行我们的应用，我们也回得到相同的结果。
这是非常酷的，因为每次只有一个线程在执行，所以我们能够保证我们的 Rails 代码是线程安全的。
但是，还有另外一个问题。</p>

<p>如果你已经把应用部署到了生产环境，并且用的是 WEBrick（你不应该用的），你的用户可能会体验到非常糟糕的性能
因为每一个只有一个线程能执行。如果有一些线程的工作需要较长时间，那么通常其他线程就需要等待了，你的用户会很恼火。</p>

<p>我们的静态资源则不会遇到这样的问题，因为，一旦响应发送回给客户端后，我们的服务器会继续服务来自其他客户端对于静态资源的请求。这是因为静态资源是被在 stack 处于第一个 middleware 的 ActionDispatch::Static 所处理。</p>

<p>我们怎么样才能不阻塞其他请求并且同时处理多个请求？我们可以先简单地禁用线程安全。
在 development.rb 或者 production.rb 文件里，启用 <code>config.threadsafe!</code>。
如果我们启用了这个选项，那么在我们的应用里会出现一系列的变化。</p>

<p>现在，你可以在按了 Infinite 按钮之后按两次 simple 按钮，它就能够拿到服务器的响应。
这是因为我们在我们的 Rails App 里启用了多线程，但是这会导致我们需要去写出线程安全的代码。
在 <a href="http://tenderlovemaking.com/2012/06/18/removing-config-threadsafe.html">Aaron Patterson 的这篇文章</a>里，
你可以了解到更多关于 config.threadsafe! 的信息。</p>

<p>我们已经演示了在 Rails 里的线程安全的概念。现在让我来分享给你更多好消息。
即使 config.threadsafe! 被禁用了，你也可以使用一个基于进程（process-based）的 web server 来处理多请求。
如果我们使用 Unicorn 或者 Apache Passenger / Nginx Passenger 这一类的 server 来运行我们的应用，
那么上面所提到的 ajax 请求，即使我们触发了 infinite 的 ajax 请求，我们也可以拿到响应。</p>

<p>这是因为，基于进程的 web server，会创建多个 worker 进程，每一个对应这我们应用的一个实例。
Apache Passenge 会给每一个请求 spawn 一个 child process。
所以，当我们引发上面提到的 infinite ajax request 的时候，一个 worker 线程会处理这个请求，
当我们发起另外一个简单的 ajax request 的时候，它将会被一个新的 child process 所处理。
Aaron Patterson 在<a href="http://tenderlovemaking.com/2012/06/18/removing-config-threadsafe.html">这篇文章</a>里提到了 <code>config.threadsafe!</code> 对于基于进程的 server 来说并没有影响。</p>

<p>我希望你今天能够学习到一些关于 Rails 和线程安全的知识，感谢阅读！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/31/threads-in-ruby/">Threads in Ruby（译）</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-31T14:27:04+08:00'><span class='date'>2014-12-31 14:27:04</span> <span class='time'>2:27 pm</span></time>
        
           | <a href="/blog/2014/12/31/threads-in-ruby/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/12/31/threads-in-ruby/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.sitepoint.com/threads-ruby/">这是原文</a></p>

<p>Ruby 有着许多吸引开发者的 cool features，例如在运行时能够创建类、修改特定对象的行为、使用 ObjectSpace 监控内存中类的数量以及大量的测试套件。这些东西使得开发者的生活更加轻松。今天我们将会讨论在计算机科学里最重要的概念之一：线程，以及 Ruby 是如何支持线程的。</p>

<h2>简介</h2>

<p>首先，让我们来定义“线程”（thread），请参考 <a href="http://en.wikipedia.org/wiki/Thread_(computing)">wikipedia</a></p>

<blockquote><p>In computer science, a thread of execution is the smallest sequence of programmed instructions that can be managed independently by an operating system scheduler. A thread is a light-weight process.</p></blockquote>

<p>线程可以堪称是一个轻量级（light-weight）的进程。
多个线程属于同个进程，并且共享着进程的资源（resources）。
这就是为什么在有些情况下使用多线程是比较经济（economical）的。</p>

<p>现在让我们来看看线程对于我们来说是多么有用。</p>

<h2>Basic Example</h2>

<p>看看下面的代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">calculate_sum</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">arr</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>    <span class="n">sum</span> <span class="o">+=</span> <span class="n">item</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">sum</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@items1</span> <span class="o">=</span> <span class="o">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="o">]</span>
</span><span class='line'><span class="vi">@items2</span> <span class="o">=</span> <span class="o">[</span><span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</span><span class='line'><span class="vi">@items3</span> <span class="o">=</span> <span class="o">[</span><span class="mi">99</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">31</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;items1 = </span><span class="si">#{</span><span class="n">calculate_sum</span><span class="p">(</span><span class="vi">@items1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;items2 = </span><span class="si">#{</span><span class="n">calculate_sum</span><span class="p">(</span><span class="vi">@items2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;items3 = </span><span class="si">#{</span><span class="n">calculate_sum</span><span class="p">(</span><span class="vi">@items3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码输出的结果为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">items1</span> <span class="o">=</span> <span class="mi">101</span>
</span><span class='line'><span class="n">items2</span> <span class="o">=</span> <span class="mi">137</span>
</span><span class='line'><span class="n">items3</span> <span class="o">=</span> <span class="mi">152</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是一个非常简单的程序，有助于弄明白我们为什么要使用多线程。在上面的代码里，我们有三个数组，并且要计算出它们的和，但有一个问题，我们无法在 items1 算出结果之前，得到 items2 的结果，
对于 items3 也同样存在这个问题。现在，让我们修改一下代码来进一步说明我想表达的东西。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">calculate_sum</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">arr</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>    <span class="n">sum</span> <span class="o">+=</span> <span class="n">item</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">sum</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在上面的代码中，我们增加了一个 <code>sleep(2)</code> 指令，让程序暂停2秒钟之后再继续运行。
这意味着，items1 会在2秒后才得到结果，items2 会在4秒后得到结果，而 items3 将会在6秒后得到结果。
这并不是我们想要的。</p>

<p>上面的三个数组，对与彼此都没有依赖，所以它们是能够独立地进行元素和的计算，这时候多线程就可以派上用场了。</p>

<p>多线程使得我们可以将当前的程序分割成为几个不同的、能够独立运行的上下文执行体（execution contexts）。
现在，让我们来将上面的程序修改成为一个多线程的版本。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">calculate_sum</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">arr</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>    <span class="n">sum</span> <span class="o">+=</span> <span class="n">item</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">sum</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@items1</span> <span class="o">=</span> <span class="o">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="o">]</span>
</span><span class='line'><span class="vi">@items2</span> <span class="o">=</span> <span class="o">[</span><span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</span><span class='line'><span class="vi">@items3</span> <span class="o">=</span> <span class="o">[</span><span class="mi">99</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">31</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">threads</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>    <span class="n">items</span> <span class="o">=</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@items</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;items</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2"> = </span><span class="si">#{</span><span class="n">calculate_sum</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">threads</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们把每一个数组元素和的计算工作，都交给一个线程来做，通过 <code>Thread.new</code> 的方式来创建线程，
并且把数组元素和的计算的代码段放到代码块中里去，这样我们一共新建了3个线程。
现在让我们来看看运行的结果，注意每次的运行结果顺序可能有所不同。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">items2</span> <span class="o">=</span> <span class="mi">137</span>
</span><span class='line'><span class="n">items3</span> <span class="o">=</span> <span class="mi">152</span>
</span><span class='line'><span class="n">items1</span> <span class="o">=</span> <span class="mi">101</span>
</span></code></pre></td></tr></table></div></figure>


<p>从运行结果来看，我们不是在4秒后收到items2的结果，6秒钟之后收到items3的结果，而是在2秒钟之后收到所有数组的结果。这让我们看到了多线程的魔力，我们是在并行地计算所有数组的元素和，而不是一次只计算一个。这是非常棒的，因为我们节省了4秒钟的时间，提高了程序的性能和效率。</p>

<h2>竞态（Race Conditions）</h2>

<p>每一个功能其实都是有代价的，多线程是好东西，但是如果你在写多线程的代码的时候，你需要了解<strong>竞态条件</strong>这个东西，那么什么是竞态呢？请参考 <a href="http://en.wikipedia.org/wiki/Race_condition#Software">wikipedia</a></p>

<blockquote><p>Race conditions arise in software when separate computer processes or threads of execution depend on some shared state. Operations upon shared states are critical sections that must be mutually exclusive. Failure to obey this rule opens up the possibility of corrupting the shared state.</p></blockquote>

<p>简单地来讲，如果我们有一些共享的数据，这些数据能够被多线程使用的话，那么我们的数据在所有的线程执行完毕之后还应该保持正确不出错。</p>

<p><strong>例子</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Item</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span><span class="p">;</span> <span class="kp">attr_accessor</span> <span class="ss">:price</span> <span class="k">end</span>
</span><span class='line'>  <span class="vi">@price</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="o">+=</span> <span class="mi">10</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Item.price = </span><span class="si">#{</span><span class="no">Item</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们创建了一个简单的 Item 类，包含了一个类变量 price。<code>Item.price</code> 的值在一个循环力不断地增加。
执行这个程序，然后你将会看到一下的输出</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在，让我们来看看一个多线程的版本</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Item</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span><span class="p">;</span> <span class="kp">attr_accessor</span> <span class="ss">:price</span> <span class="k">end</span>
</span><span class='line'>  <span class="vi">@price</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">threads</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>    <span class="n">item_price</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="c1"># Reading value</span>
</span><span class='line'>    <span class="nb">sleep</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="p">))</span>
</span><span class='line'>    <span class="n">item_price</span> <span class="o">+=</span> <span class="mi">10</span>        <span class="c1"># Updating value</span>
</span><span class='line'>    <span class="nb">sleep</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="p">))</span>
</span><span class='line'>    <span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">item_price</span> <span class="c1"># Writing value</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">threads</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Item.price = </span><span class="si">#{</span><span class="no">Item</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们的 Item 类还是一样的，但是，我们已经改变了 price 的递增方式。我们在代码里使用了 sleep 来向你展示在并发中可能出现的问题。多跑几次程序，你将会得到不同的结果。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="mi">40</span>
</span></code></pre></td></tr></table></div></figure>


<p>多次运行我们的程序下来，我们会发现，结果不再正确，并且结果是变化的。
输出的不再是 100，你看到的可能是30、40或者70等。
这就是竞态所导致的结果。</p>

<h2>互斥体</h2>

<p>为了解决竞态所产生的问题，我们必须要控制程序，
当一个线程正在工作时，另外一个线程必须等待，直到当前的工作进程完成工作。
这个行为我们称为互斥，下面我们将阐述如何去使用互斥体。</p>

<p>Ruby 已经为我们使用互斥体提供了一个非常简洁的方式，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Item</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span><span class="p">;</span> <span class="kp">attr_accessor</span> <span class="ss">:price</span> <span class="k">end</span>
</span><span class='line'>  <span class="vi">@price</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">mutex</span> <span class="o">=</span> <span class="no">Mutex</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'><span class="n">threads</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>    <span class="n">mutex</span><span class="o">.</span><span class="n">synchronize</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">item_price</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="c1"># Reading value</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="p">))</span>
</span><span class='line'>      <span class="n">item_price</span> <span class="o">+=</span> <span class="mi">10</span>        <span class="c1"># Updating value</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="p">))</span>
</span><span class='line'>      <span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">item_price</span> <span class="c1"># Writing value</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">threads</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Item.price = </span><span class="si">#{</span><span class="no">Item</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在运行这个程序，你将会看到</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Item</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是因为 <code>mutex.synchronize</code>，在任何时候，每一个都有且仅有一个线程能够执行 <code>mutex.synchronize</code> 里的代码块，其他的线程必须等待直到当前的工作线程执行完毕。</p>

<p>这样，我们的代码就是<strong>线程安全</strong>了。</p>

<p>Rails 是线程安全的，当多个线程尝试去运行同样的代码是，它使用了 Mutex 类的一个实例来避免
竞态的出现。请查看 <code>Rack::Lock</code> 这个中间件里的代码，你会发现它使用了 <code>@mutext.lock</code> 来阻塞其他尝试想要运行相同代码的线程。如果你想要了解 Rails 里更多关于多线程的细节，
请阅读我的<a href="http://www.sitepoint.com/config-threadsafe/">这篇文章</a>。
另外，你也可以访问 <a href="http://www.ruby-doc.org/core-2.0.0/Mutex.html">Ruby Mutext</a> 这个类有关的文档。</p>

<h2>不同 Ruby 版本的线程类型</h2>

<p>在 Ruby 1.8 版本里，Ruby 的实现是<strong>绿色线程</strong>（green threads）。绿色线程是由解释器来实现和控制的，下面是一些关于绿色线程的优点和缺点：</p>

<p><strong>优点</strong></p>

<ul>
<li>Cross platform (managed by the VM)</li>
<li>Unified behavior / control</li>
<li>Lightweight -> faster, smaller memory footprint</li>
</ul>


<p><strong>缺点</strong></p>

<ul>
<li>Not optimized</li>
<li>Limited to 1 CPU</li>
<li>A blocking I/O blocks all threads</li>
</ul>


<p>到了 Ruby 1.9 版本后，Ruby 使用的是原生线程（native threads）。原生线程的意思是每个线程都是由 Ruby 创建的，并且直接映射到操作系统级别的线程。每一门现代编程语言都实现了 native threads，所以使用 native threads 是更加直接和合理的。下面是一些关于 native threads 的优点：</p>

<p><strong>优点</strong></p>

<ul>
<li>Run on multiple processors</li>
<li>Scheduled by the OS</li>
<li>Blocking I/O operations don’t block other threads</li>
</ul>


<p>虽然在 Ruby 1.9 里使用的是 native threads，但是即使我们的处理器是多核的，
每次运行时都仍然只有一个线程能运行。这是因为 MRI 的 GIL (Global Interpreter Lock)
或者说 GVL (Global VM Lock)。在 Ruby 中，如果有一个线程正在运行，
那么 GIL 就会阻止其他线程运行。但是 Ruby 足够聪明来切换到其他正在等待的线程，
如果当前正在运行的线程正在等待一些 I/O 操作完成的话。</p>

<p>在 Ruby 中使用线程是非常容易的，但是我们必须谨慎地处理好并发可能产生地问题。
我希望你能喜欢这篇文章并且在 Ruby 中能够更好地使用好线程。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/30/thread/">Thread</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-30T18:44:05+08:00'><span class='date'>2014-12-30 18:44:05</span> <span class='time'>6:44 pm</span></time>
        
           | <a href="/blog/2014/12/30/thread/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/12/30/thread/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>进程、线程</h2>

<p>进程是指操作系统中正在运行的一个程序；线程是系统分配处理器时间的基本单元，或者说进程之类独立执行的一个单元。</p>

<p>对于操作系统而言，其调度单元是线程。</p>

<p>一个进程至少包括一个线程，通常将该线程称为主线程。进程从主线程的执行开始，进而创建一个或多个附加线程，这就是所谓的基于多线程的多任务。</p>

<p>进程是对正在运行程序的一个抽象，是一组资源（处理器、内存以及I/O设备）的集合体，进程把资源集中到一块，而线程才是 CPU 调度的实体。</p>

<p>进程与进程之间，内存空间是独立的，而线程与线程之间内存是共享的。</p>

<p>在单处理器的系统中，多线程是按时间片方式运行，即并发；
在多处理器的系统中，多个线程可以同时运行，即并行。</p>

<h2>线程模型</h2>

<ul>
<li><p><strong>内核级别线程（kernel-level threads）</strong></p>

<p>内核级别线程，是内核调度的基本单元，在每个进程中，至少存在一个内核级别线程。</p></li>
<li><p><strong>用户级别线程（user-level threads）</strong></p>

<p>用户进程自己实现的进程机制。在这种情况下，内核是不知道有多少线程存在的，同时线程上下文切换更快，而且在不支持多线程的操作系统上也能实现多线程。但是这种线程无法充分利用多处理器系统，如果进程中的一个线程执行阻塞的I/O请求，那么整个进程就会被阻塞。现在，大部分应用程序起来之后，其主线程就是一个用户级别的线程，它所能访问的资源是有限制的。</p></li>
<li><p><strong>混合线程（hybrid threads）</strong></p>

<p>混合线程，是内核级别线程和用户级别线程的混合体，提供了以上两种模型的优点，但带来很大的复杂性。</p></li>
</ul>


<p>另外，不得不提的是另一个模型：<strong>绿色线程</strong>。</p>

<p>绿色线程是指有虚拟机（VM）调度的线程，而不是通过内核调度，所以绿色线程是用户级别的线程。</p>

<h2>线程安全</h2>

<p>  线程安全是多线程编程里的一个概念。一片代码段，当多个线程能以一种保证安全的方式同时操纵共享的数据结构时，那么这片代码段是线程安全的。</p>

<h2>References</h2>

<ul>
<li><a href="http://en.wikipedia.org/wiki/Thread_(computing)">Thread</a></li>
<li><a href="http://en.wikipedia.org/wiki/Thread_safety">Thread Safety</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/25/active-support-instrumentation/">Instrumentation in ActiveSupport</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-25T21:08:03+08:00'><span class='date'>2014-12-25 21:08:03</span> <span class='time'>9:08 pm</span></time>
        
           | <a href="/blog/2014/12/25/active-support-instrumentation/#disqus_thread"
             data-disqus-identifier="http://www.justqyx.me/blog/2014/12/25/active-support-instrumentation/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ActiveSupport 是 Rails 的基础组件，其中包含了一个 Instrumentation API。<br/>
Instrumentation 让我们能够订阅某些事件，然后产生相关的数据和做另外某些事情。<br/>
AcitveSupport 所实现的 Instrumentation API 不仅仅可以在 Rails 项目中使用，也可以在非 Rails 项目中使用。<br/>
个人认为 Instrumentation 应该像是 Specification 之类东西，其他语言也应该有各自的一些实现。</p>

<h2>Instrumentation 能够做什么</h2>

<blockquote><p>The instrumentation API provided by ActiveSupport allows developers
to provide hooks which other developers may hook into. Ther are several
of there within the Rails framework.</p>

<p>With this API, developers can choose to be notified when certain
events occur inside their application or another piece of Ruby code.</p></blockquote>

<p>简单地来讲，就是去订阅某些事件，然后做你想做的事情。例如，在 Rails 中， <br/>
我们可以在一个请求结束时，收集本次请求的一些数据（如：渲染 view 所使用的时间、<br/>
数据库查询所花费的时间、本次请求总共所花费的时间等等）。</p>

<h2>The hooks inside the Rails framework for instrumentation</h2>

<p>在 Rails 中，已经实现了许多事件的 hooks（框架就是干这种脏活累活的）。分为以下八大类：</p>

<ul>
<li>Action Controller</li>
<li>Active View</li>
<li>Active Record</li>
<li>Active Mailer</li>
<li>Active Resource</li>
<li>Active Supportt</li>
<li>Railties</li>
<li>Rails</li>
</ul>


<p>每个类别下具体的 hook event，在 <a href="http://edgeguides.rubyonrails.org/active_support_instrumentation.html#rails-framework-hooks">Rails Guide</a> 文档里可以找到。
在 Action Controller 这个类别里，有一个 <strong>process_action.action_controller</strong>，
它就是收集了一次请求里的一些数据。如下：</p>

<p><img src="/downloads/images/process_action.action_controller.png"></p>

<p>以上是一个 hook event 所提供的数据，但还有另外的几个由 subcriber 提供的数据，下个 section 会提及。</p>

<h2>Subscribing to an event</h2>

<p>在 Rails 中，subcribe an event 是非常简单的，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">subscribe</span> <span class="s2">&quot;process_action.action_controller&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">started</span><span class="p">,</span> <span class="n">finished</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">data</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># name 即 event 的名字</span>
</span><span class='line'>  <span class="c1"># started 即 event 的开始时间</span>
</span><span class='line'>  <span class="c1"># finsihed 即 event 的结束时间</span>
</span><span class='line'>  <span class="c1"># unique_id 即 event 的 unique ID</span>
</span><span class='line'>  <span class="c1"># data 即上文表格中的数据</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外，还可以将 block 的参数，传给 <strong>ActiveSupport::Notifications::Event</strong> 构造一个 event object，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">subscribe</span> <span class="s2">&quot;process_action.action_controller&quot;</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>  <span class="n">event</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="o">.</span><span class="n">new</span> <span class="o">*</span><span class="n">args</span>
</span><span class='line'>  <span class="n">event</span><span class="o">.</span><span class="n">name</span>     <span class="c1"># =&gt; &quot;process_action.action_controller&quot;</span>
</span><span class='line'>  <span class="n">event</span><span class="o">.</span><span class="n">duration</span> <span class="c1"># =&gt; 整个事件所花费的时间，单位是毫秒(ms)</span>
</span><span class='line'>  <span class="n">event</span><span class="o">.</span><span class="n">payload</span>  <span class="c1"># =&gt; 上文的 data</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后，subcribe 还支持正则表达式，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">subscribe</span> <span class="sr">/action_controller/</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># inspect all ActionController events</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Building a custom instrumentation implementation</h2>

<p>先来看看如何 instrument an event</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">instrument</span> <span class="s2">&quot;custom.event&quot;</span><span class="p">,</span> <span class="ss">extra</span><span class="p">:</span> <span class="ss">:hello_world</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># do your custom stuff code</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先，会执行 block 中的代码，执行完毕之后，就会立即 notify all subscribers。<br/>
<strong>custom.event</strong> 是事件的名字，其余的参数就是 data（subcribe 那里的 data 参数），<br/>
在这里就是 <code>{ extra: :hello_world }</code> 了。</p>

<p>下面的代码则是去订阅 custom.event，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">.</span><span class="n">subscribe</span> <span class="s2">&quot;custom.event&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">started</span><span class="p">,</span> <span class="n">finished</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">data</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">data</span><span class="o">.</span><span class="n">inspect</span> <span class="c1"># =&gt; { :extra =&gt; :hello_world }</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<ul>
<li><a href="http://edgeguides.rubyonrails.org/active_support_instrumentation.html">Active Support Instrumentation</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/11/26/keep-attribute-safe-in-rails/">字段加密存储-Rails</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/19/rubocop/">Use Rubocop to Control Your Ruby Code's Quality</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/13/actioncable-sourcecode-frontend-part-3-monitor/">ActionCable 源码阅读笔记-前端部分-3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/13/actioncable-sourcecode-frontend-part-2-connection/">ActionCable 源码阅读笔记-前端部分-2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/13/actioncable-sourcecode-frontend-part-1-hello/">ActionCable 源码阅读笔记-前端部分-1</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/justqyx">@justqyx</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'justqyx',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - 邱源鑫 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yuanxin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
